/*
 * A TEI Viewer for East Asian Pre-Modern Texts
 *
 * Copyright 2024 International Institute for Digital Humanities
 * Copyright 2024 FLX Style
 * Released under the GPL
 *
 * Originally written by Kiyonori NAGASAKI (International Institute for Digital Humanities)
 * Further developed by Jun HOMMA (FLX Style)
 */
/**
 * getElementXPath() and getElementTreeXPath() are based on firebug
 * https://github.com/firebug/firebug/blob/master/extension/content/firebug/lib/xpath.js
 * 
 * firebug
 * BSD License
 * Copyright (c) 2009, Mozilla Foundation
 * https://github.com/firebug/firebug/blob/master/extension/license.txt
 */
"use strict";function copyAttributes(t,e){const n=t.attributes;for(const t of n){const n=t.name;0===n.indexOf("xml:")?(e.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,t.value),e.setAttribute("data-"+n.replace(":",""),t.value)):n.indexOf(":")>-1?(e.setAttributeNS(null,n,t.value),e.setAttribute("data-"+n.replace(":",""),t.value)):0===n.indexOf("data-")?e.setAttribute(n,t.value):"id"===n?e.setAttribute("id",t.value):e.setAttribute("data-"+n,t.value)}t.hasAttribute("style")&&e.setAttribute("style",t.getAttribute("style"))}function preprocessSelfClosingTags(t){const e=[{xml:"anchor"},{xml:"milestone"},{xml:"lb",html:"br"},{xml:"pb"}];for(const n of e)t.querySelectorAll(n.xml).forEach(e=>{const a=n.html||"param",o=t.createElement(a);o.setAttribute("class",n.xml),copyAttributes(e,o),e.parentNode.replaceChild(o,e)})}function preprocessXmlId(t,e){const n=e||"";t.querySelectorAll("[*|id]").forEach(t=>{if(!t.hasAttribute("id")){const e=n+t.getAttribute("xml:id");t.setAttribute("id",e)}})}function replaceWithElement(t,e){const n=t.nodeName.toLowerCase(),a=document.createElement(e);if(a.setAttribute("class",n),a.setAttribute("data-original-tag-name",t.nodeName),copyAttributes(t,a),t.hasChildNodes()){const e=t.childNodes;for(const t of e)a.appendChild(t.cloneNode(!0))}t.parentNode.replaceChild(a,t)}function normalizeSpaceXML(t){const e=(new DOMParser).parseFromString('<?xml version="1.0" encoding="UTF-8"?><xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:tei="http://www.tei-c.org/ns/1.0"><xsl:template match="*[not(node())]"><xsl:copy><xsl:apply-templates select="@*" /><xsl:comment></xsl:comment></xsl:copy></xsl:template><xsl:template match="node()|@*"><xsl:copy><xsl:apply-templates select="@*" /><xsl:apply-templates /></xsl:copy></xsl:template><xsl:template match="text()"><xsl:value-of select="normalize-space(.)" /></xsl:template></xsl:stylesheet>',"application/xml"),n=new XSLTProcessor;return n.importStylesheet(e),n.transformToDocument(t)}function showAppPlace(t,e,n,a,o){function i(e,n,a,o,i){!function e(n,a,o,i,s,c){const l=n.childNodes;for(const n of l){const l=n.nodeType;let r=!1,d=!1,p=!1;if(l===Node.ELEMENT_NODE&&"param"===n.nodeName&&(r=!0,n.hasAttribute("xml:id"))){const t=n.getAttribute("xml:id");t===i&&(d=!0),t===s&&(p=!0)}if(r||l===Node.TEXT_NODE){let e=!1;if(r?(d&&(c.flag=!0),p&&(c.flag=!1),(d||p)&&(e=!0)):l===Node.TEXT_NODE&&c.flag&&n.textContent.trim().length>0&&(e=!0),e){const e=t.createElement("span");e.className="ct",e.setAttribute("data-n",String(o)),e.appendChild(n.cloneNode(!0)),a.appendChild(e)}else a.appendChild(n.cloneNode(!0))}else if(l===Node.ELEMENT_NODE||l===Node.DOCUMENT_NODE||l===Node.DOCUMENT_FRAGMENT_NODE){const t=n.cloneNode(!1);a.appendChild(t),e(n,t,o,i,s,c)}}}(e,n,a,o,i,{flag:!1})}n||(n=1);let s=n-1;const c=[],l={};for(const n of Object.keys(e))for(var r=0;r<e[n].length;r++){const h=n,u=e[n][r],f=t.getElementById(o+h),m=t.getElementById(o+u);if(s++,h in l||(l[h]=[]),l[h].push(s),f){const o=a?s:getCjkDecimal(s),g=m?"":"（範囲の終わり "+u+" がありません）";if(m||c.push({type:"appToNotFound",anchorNo:s,appFrom:h,appTo:u}),r>0)for(var d=r-1;d>=0;d--)if(e[n][d]===u){c.push({type:"duplicate",anchorNo:s,appFrom:h,appTo:u,anchorNoRef:l[h][d]});break}const b=t.createElement("span");if(b.className="ft artifact",b.setAttribute("data-n",String(s)),b.textContent=o+g,f.parentNode.insertBefore(b,f),m){const e=new Range;if(e.setStartBefore(f),e.setEndAfter(m),e.startContainer===e.endContainer){const n=t.createElement("span");n.className="ct",n.setAttribute("data-n",String(s));try{e.surroundContents(n)}catch(t){console.log(t)}}else{const t=e.commonAncestorContainer;var p=t.cloneNode(!1);i(t,p,s,h,u),t.parentNode.replaceChild(p,t)}}else console.log(g)}}return c}function preprocessInlineNote(t,e,n,a,o){n||(n=[]);const i=(o=o||"")+"note_start_",s=o+"note_end_";let c=1;!function t(e){0!==e.childNodes.length&&e.childNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE&&"param"===e.nodeName&&!e.hasAttribute("xml:id")&&"noteEnd"===e.getAttribute("data-type")){const t=s+String(c).padStart(8,"0");e.setAttributeNS("http://www.w3.org/XML/1998/namespace","xml:id",t),e.hasAttribute("id")||e.setAttribute("id",o+t),c++}t(e)})}(t);let l=1;!function t(e,o){0!==e.childNodes.length&&e.childNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){if("span"===e.nodeName&&"note"===e.getAttribute("class")){let t=!0;a&&a.length>0?t=!1:n.length>0&&(t=!0);let s,c=!1,r=!1;a&&a.length>0?e.hasAttribute("data-type")&&(s=e.getAttribute("data-type"),a.indexOf(s)>-1&&(c=!0)):n.length>0&&e.hasAttribute("data-type")&&(s=e.getAttribute("data-type"),n.indexOf(s)>-1&&(r=!0)),(!t&&c||t&&!r)&&(e.setAttribute("data-n",l),l++),e.hasAttribute("data-target")?e.setAttribute("data-target",e.getAttribute("data-target").replace(/^#/,"")):e.hasAttribute("xml:id")&&e.setAttribute("data-target",i+e.getAttribute("xml:id")),e.hasAttribute("data-targetend")?e.setAttribute("data-targetend",e.getAttribute("data-targetend").replace(/^#/,"")):(!t&&c||t&&!r)&&o.push(e)}if(o.length>0&&"param"===e.nodeName&&"noteEnd"===e.getAttribute("data-type")&&e.hasAttribute("xml:id")){const t=e.getAttribute("xml:id");o.pop().setAttribute("data-targetend",t)}}t(e,o)})}(t,[]),function t(e,n){0!==e.childNodes.length&&e.childNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE&&"span"===e.nodeName&&"note"===e.getAttribute("class")){var a=e.getAttribute("data-target"),o=e.getAttribute("data-targetend");a&&o&&(a in n||(n[a]=[]),n[a].push(o))}t(e,n)})}(t,e),t.querySelectorAll("span.note").forEach(e=>{const n=t.createElement("param");if(n.setAttribute("class","anchor"),e.hasAttribute("xml:id")){const t=i+e.getAttribute("xml:id");n.setAttributeNS("http://www.w3.org/XML/1998/namespace","xml:id",t),n.setAttribute("id",o+t)}e.after(n)})}function postprocessInlineNote(t){const e=t.querySelectorAll("span.ct");for(var n=0;n<e.length;n++){const t=e[n],a=n>0?e[n-1]:void 0,o=n<e.length-1?e[n+1]:void 0,i=t.getAttribute("data-n"),s=a?a.getAttribute("data-n"):void 0,c=o?o.getAttribute("data-n"):void 0;i===s&&t.setAttribute("data-n-prev-same","true"),i===c&&t.setAttribute("data-n-next-same","true")}}function getCjkDecimal(t){const e=["〇","一","二","三","四","五","六","七","八","九"],n=String(t);let a="";for(var o=0;o<n.length;o++){a+=e[parseInt(n[o].codePointAt(0))-48]}return a}function checkVariantEncodingMethod(t){let e=void 0;return t.querySelectorAll("TEI > teiHeader > encodingDesc > variantEncoding").forEach(t=>{if(t.hasAttribute("method")){const n=t.getAttribute("method");e=["location-referenced","double-end-point","parallel-segmentation"].indexOf(n)>-1?n:null}}),e}function isDiplomaticAnnotatedDocument(t){let e=!1;return t.querySelectorAll('TEI > teiHeader > encodingDesc seg[type="annotation"]').forEach(t=>{"diplomatic"===t.textContent&&(e=!0)}),e}function getElementXPath(t){return t&&t.id?'//*[@id="'+t.id+'"]':getElementTreeXPath(t)}function getElementTreeXPath(t){for(var e=[];t&&t.nodeType==Node.ELEMENT_NODE;t=t.parentNode){for(var n=0,a=!1,o=t.previousSibling;o;o=o.previousSibling)o.nodeType!=Node.DOCUMENT_TYPE_NODE&&o.nodeName==t.nodeName&&++n;for(o=t.nextSibling;o&&!a;o=o.nextSibling)o.nodeName==t.nodeName&&(a=!0);var i=(t.prefix?t.prefix+":":"")+t.localName,s=n||a?"["+(n+1)+"]":"";e.splice(0,0,i+s)}return e.length?"/"+e.join("/"):null}const TEIViewer=function(t){console.log("A TEI Viewer for East Asian Pre-Modern Texts 0.1.0+20250228");const e={},n={},a={},o={},i="facsimile_surfaceGrp_surface_zone",s={DEFAULT:0,MANYO:1,WAKASHUU:4,UTAAWASE:5};let c=s.DEFAULT;const l={DEFAULT:0,VERTICAL:0,HORIZONTAL:1};let r=l.DEFAULT,d="ja";{const t=new URLSearchParams(window.location.search);t.has("lang")&&("en"!==t.get("lang")&&"ja"!==t.get("lang")||(d=t.get("lang")))}$.isPlainObject(t)||(t={}),function(){$.isArray(t.xmlidPickup)||(t.xmlidPickup=[]),t.xmlidPickupSelector=[],t.xmlidPickupDict={};for(let e of t.xmlidPickup)$.isPlainObject(e)&&e.selector&&-1===t.xmlidPickupSelector.indexOf(e.selector)&&(t.xmlidPickupSelector.push(e.selector),t.xmlidPickupDict[e.selector]=e.label||e.selector)}(),function(){if(t.xmlidListPickupSelector=[],t.xmlidListPickupDict={},t.xmlidListPickupOption={},t.xmlidListPickup)for(let e of t.xmlidListPickup)$.isPlainObject(e)&&e.selector&&-1===t.xmlidListPickupSelector.indexOf(e.selector)&&(t.xmlidListPickupSelector.push(e.selector),t.xmlidListPickupDict[e.selector]=e.label||e.selector,t.xmlidListPickupOption[e.selector]=e)}(),$.isPlainObject(t.typeToGraphLabelMapping)||(t.typeToGraphLabelMapping={}),t.enableGraph=!!t.enableGraph,t.useOpenSeadragon=!0,$.isPlainObject(t.openSeadragon)||(t.openSeadragon={}),t.openSeadragon.highlight=!(!t.openSeadragon.highlight&&"highlight"in t.openSeadragon),t.showLegends=!(!t.showLegends&&"showLegends"in t),t.showVersions=!(!t.showVersions&&"showVersions"in t),t.showChoice=!(!t.showChoice&&"showChoice"in t),t.showTextStructures=!(!t.showTextStructures&&"showTextStructures"in t),t.enableBodyResize=!(!t.enableBodyResize&&"enableBodyResize"in t),t.enableSearch=!!t.enableSearch,t.enableFileDescTab=!(!t.enableFileDescTab&&"enableFileDescTab"in t),t.fixedAppType=!!("appType"in t),"appType"in t&&(c=t.appType);let p=!1;{const t=new URLSearchParams(window.location.search);if(t.has("debug")&&(p=!!t.get("debug")),t.has("file"))try{const e=t.get("file"),n=new URL(e,window.location.href);$.ajax(n.href,{type:"get"}).done(function(t){$('#input1 input[type="file"]').hide(),$("#input1").append(e);let n={target:{}};n.target.result=(new XMLSerializer).serializeToString(t),h(n)})}catch(t){console.log(t)}}function h(o,h){const u=(new Spin.Spinner).spin(document.body);(async function(o,h){const u=h||1,g=$("#body_result"+(h||""));g.html("");const x=$("#bottom_result"+(h||""));let v,C;x.html(""),$("#graph_result").html(""),$("#errors").html(""),$("#legends").html(""),$("#versions").html(""),$("#choice").html(""),$("#additionalUIs").empty();let A=!0;const S=normalizeSpaceXML($.parseXML(o.target.result));preprocessSelfClosingTags(S);const E=function(t){let e,n;do{e=Math.random().toString(16).substr(2,8),n=!(null===document.querySelector('[id^="'+e+'"]')&&null===t.querySelector('[*|id^="'+e+'"]'))}while(n);return e}(S)+"_";preprocessXmlId(S,E);const T=checkVariantEncodingMethod(S);!t.fixedAppType&&isDiplomaticAnnotatedDocument(S)&&(c=s.MANYO);$(S).find("TEI > text > body").each(function(){const t=$(this).attr("style");t&&/writing-mode:\s*horizontal-tb/i.test(t)&&(r=l.HORIZONTAL)}),r===l.HORIZONTAL&&($("#text_body").css("writing-mode","horizontal-tb").addClass("writing-mode-horizontal-tb"),$("#body_result").css({overflow:"auto",height:"100%"}));var _,L;switch($(S).find("TEI > teiHeader").each(function(e,n){const a=$(n);let o=!1;const i=$("<div>").addClass("teiHeader");a.find("fileDesc").each(function(){const e=$(this),n=$("<div>").addClass("fileDesc");i.append(n),e.find("titleStmt").each(function(){const e=$(this),a=$("<div>").addClass("titleStmt");e.find("title").each(function(){const e=$(this),n=$("<div>").addClass("title").html(e.html());a.append(n);const o=e.text();t.fixedAppType||(0===o.indexOf("萬葉集")?c=s.MANYO:o.includes("和歌集")?c=s.WAKASHUU:o.endsWith("歌合")&&(c=s.UTAAWASE));let i=t.appName||"TEI古典籍ビューワ";$("title").text([o,i].join(" | "))}),e.find("author,editor,funder,meeting,principal,respStmt,sponsor").each(function(){const t=$("<div>").addClass(this.tagName).html($(this).html());a.append(t)}),n.append(a),o=!0}),t.enableFileDescTab&&(_=$("<div>").addClass("publicationStmt mb-3"),e.find("publicationStmt").each(function(){const t=$(this);let e;_.append(b("電子テキストの出版情報"));const n=this.firstChild;if(n){const t=n.tagName.toLowerCase();e="publisher"===t||"distributor"===t||"authority"===t}const a=$("<div>");e?t.find("publisher,distributor,authority,availability").each(function(){const t=$("<div>").addClass(this.tagName).html($(this).html());a.append(t)}):a.append(t.html()),_.append(a)}),L=$("<div>").addClass("sourceDesc"),e.find("sourceDesc").each(function(){const t=$(this);L.append(b("電子テキストのソースの情報")),t.find("bibl").each(function(){const t=$(this);if(t.text().length){const e=$("<div>").addClass("bibl"),n=y("書誌情報");e.append(n).append(t.html()),L.append(e)}}),t.find("msDesc").each(function(){const t=$(this),e=$("<div>").addClass("msDesc"),n={msIdentifier:{label:"手稿の識別情報",blockTags:["idno","altIdentifier","collection","institution","msName","repository","bloc","country","district","geogName","objectName","placeName","region","settlement"]},msContents:{label:"手稿の内容",blockTags:["p","textLang","ab","msItem","msItemStruct","summary","titlePage"]},physDesc:{label:"物理的側面の記述",blockTags:["p","ab","accMat","additions","bindingDesc","decoDesc","handDesc","musicNotation","objectDesc","scriptDesc","sealDesc","typeDesc"]},history:{label:"由来",blockTags:["p","ab","acquisition","origin","provenance","summary"]}};if(t.find("msIdentifier,msContents,physDesc,history").each(function(){const t=$(this),a=n[this.tagName]||{},o=(i=a.label||this.tagName,$("<div>").addClass("heading3").text(i));var i;const s=$("<div>").addClass(this.tagName).append(o);let c;const l=a.blockTags||[];if(l.length){const e="div";for(const n of l)if(n!==e)for(c=t.find(n);c.length>0;)c.each(function(){replaceWithElement(this,e)}),c=t.find(n)}t.text().length&&(s.append(t.html()),e.append(s))}),e.text().length){const t=y("手稿に関する記述");e.prepend(t),L.append(e)}})}))}),o&&g.append(i)}),c){case s.MANYO:$("#text_body").addClass("manyo").css("max-height",""),$("#text_bottom").addClass("manyo"),t.enableGraph=!1,t.enableBodyResize=!1;break;case s.WAKASHUU:$("#text_body").addClass("wakashuu"),t.openSeadragon.highlight=!0;break;case s.UTAAWASE:$("#text_body").addClass("utaawase"),t.openSeadragon.highlight=!0}switch(c){case s.MANYO:break;case s.WAKASHUU:case s.UTAAWASE:}let O={};switch(c){case s.MANYO:case s.WAKASHUU:case s.UTAAWASE:break;default:t.enableSearch=!1}const M=/^(合点|注|異文|異訓|訓)$/;let P=1;function D(t){return E+t}function I(t){return E+"anchor_xmlid_"+t}function U(t){if(A)return;const e=t||$("#body_result"),n={},a=$("#text_body .text:first").height();e.find(".note").each(function(t,e){const a=e.getAttribute("data-type");if(a&&a.match(M)){const t=e.getAttribute("data-target"),a=$("#"+I(t));let o,i;const s=a.position();s?(o=s.top,i=s.left):(o=0,i=void 0);const c=a.width();n[t]={top:o,left:i,width:c}}}),e.find(".note").each(function(t,e){const o=$(e),i=o.attr("data-type");if(i&&i.match(M)){const t=o.attr("data-target");if(t in n){const e=n[t];let i=e.top,s=e.left,c=e.width,l=e.end||{};const r={},d=o.attr("data-place");let p;if(void 0!==s&&(s="right"===d||"margin-right"===d?"calc("+(s+=c)+"px + 0.1em)":"left"===d||"margin-left"===d?"calc("+(s-=c)+"px - 0.1em)":"calc("+(s+=c)+"px + 0.1em)",r.left=s),"margin-bottom"===d)p=0;else if("above"===d)p=a-i+"px";else if("margin-head"===d){i=0;const t=o.attr("data-subtype");"貼紙"!==t&&(r.height="5rem")}else"below"===d&&l&&(i=l.top+"px");void 0!==p?r.bottom=p:r.top=i,Object.keys(r).length&&o.css(r),o.draggable()}}})}function j(t){const e="xml:idに重複があります。"+t;console.error(e),$("#errors").append($("<div>").addClass("color-red").text(e))}if(await async function(){await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>requestAnimationFrame(t))}(),$(S).find("TEI > text").each(function(o,l){let r="";const h={},m=P,y=$(l),k=$("<div>").addClass("text");function _(t,e,n){const a=$(t);a.attr("data-app-n",P);const o=[];a.children("lem").each(function(){const t=$(this),e=t.html(),n=t.attr("wit")||"本文",a=n.split(" "),i=[];a.forEach(function(t){i.push('<span class="wtnm">'+t.replace(/^#/,"")+"</span>")});const s=t.attr("facs"),c=$("<div>").addClass("lem"),l=$("<span>").addClass("footnote-head").html("［"+i.join(" ")+"］"),r=s?$("<span>").addClass("footnote-facs").attr({facs:s}):"",d=$("<span>").addClass("footnote-content").html(e);c.attr({"data-wit":n,"data-n":String(P)}).append(l).append(r).append(d),o.push(c.prop("outerHTML")),t.attr("data-app-n",P),t.attr("data-facs-backup",s),t.removeAttr("facs")}),a.children("rdg").each(function(){const t=$(this),n=t.html(),i=t.attr("wit");if(i){const a=i.split(" "),s=[];a.forEach(function(t){s.push('<span class="wtnm">'+t.replace(/^#/,"")+"</span>")});const c=t.attr("facs"),l=$("<div>").addClass("rdg"),r=$("<span>").addClass("footnote-head").html("［"+s.join(" ")+"］"),d=c?$("<span>").addClass("footnote-facs").attr({facs:c}):"",p=$("<span>").addClass("footnote-content").html(n);if(l.attr({"data-wit":i,"data-n":String(P)}).append(r).append(d).append(p),o.push(l.prop("outerHTML")),"double-end-point"!==e){const e=$("<span>");i&&e.attr("data-wit",i);const a=$("<span>").addClass("rdg").addClass("parallel-segmentation-rdg").html(n);i&&(a.attr("wit",i),a.attr("data-app-n",P)),e.append(a),t.replaceWith(e)}}else console.error("<rdg> without @wit found!"),console.error(a)}),a.children("note").each(function(){o.push('<div class="note">'+$(this).html()+"</div>")});const i=getCjkDecimal(P);let s,c;if("double-end-point"===e)s=(a.attr("from")||"").replace(/^#/,""),c=(a.attr("to")||"").replace(/^#/,"");else{s=n+"_"+P+"s",c=n+"_"+P+"e";const t=$("<param>").addClass("anchor").attr({id:D(s),"xml:id":s}),e=$("<param>").addClass("anchor").attr({id:D(c),"xml:id":c});a.prepend(t).append(e)}r+='<div class="app" data-n="'+String(P)+'"><div class="appnum" title="クリックでハイライト切り替え">'+i+'<span class="cthltgl" title="ハイライト切り替え"><span class="ui-icon ui-icon-radio-on"></span></span></div>'+o.join("")+"</div>",s in h||(h[s]=[]),h[s].push(c),P++}if(y.find("[rend]").each(function(){const t=$(this),e=t.attr("rend");e&&e.split(" ").forEach(function(e){"italic"===e&&t.addClass("italic")})}),y.find("listApp").each(function(){$(this).find("app").each(function(){_(this,"double-end-point")})}),(0===Object.keys(h).length||"double-end-point"!==T)&&y.find("body").each(function(){const t=E;$(this).find("app").each(function(){_(this,"parallel-segmentation",t)})}),0===Object.keys(h).length);else{let t;void 0===T?t="&lt;encondingDesc&gt;以下の&lt;variantEncoding&gt;の@method属性で、methodを記述しなければ&lt;app&gt;は表示できません。":null===T?t='&lt;encondingDesc&gt;以下の&lt;variantEncoding&gt;の@method属性値が誤っています。本ビューワでは"double-end-point", "parallel-segmentation"のいずれかを指定してください。':"location-referenced"===T&&(t='&lt;encondingDesc&gt;以下の&lt;variantEncoding&gt;の@method属性値について、本ビューワでは"location-referenced"の表示には未対応です。'),t&&(r=t)}""!==r&&(C=!0,x.append(r)),t.enableGraph&&$("#graph_result").prepend('<div class="alert alert-light alert-dismissible fade show mt-2 mb-0" role="alert">本文のマウスオーバーでグラフ表示、そのままクリックでグラフを固定します。<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');const L=t.xmlidListPickupSelector;if(t.enableXmlidListPickup)for(const t of L)y.find(t).each(function(){if(this.hasAttribute("xml:id")){const e=this.getAttribute("xml:id");t in a||(a[t]=[]),a[t].push(e)}});const O=t.xmlidPickupSelector;if(O.length){N(y,"corresp"),N(y,"sameAs"),N(y,"target");for(const t of O)y.find(t).each(function(){if(this.hasAttribute("xml:id")){const a=this.getAttribute("xml:id");if(t in e||(e[t]={}),a in e[t]){let t=!0;t&&j(a)}else{const o=n.corresp[a]||[],i=n.sameAs[a]||[],s=n.target[a]||[];e[t][a]={tag:this.nodeName.toLowerCase(),type:this.hasAttribute("type")?this.getAttribute("type"):void 0,corresps:o,sameAses:i,targets:s,text:this.textContent,node:this,parallelTextNo:u}}}})}const z="teiHeader_fileDesc_sourceDesc_listWit_witness";let H=!1,X=!1;$(S).find("TEI > teiHeader > fileDesc > sourceDesc listWit").each(function(){const n=z;t.xmlidPickupDict[n]="対校資料",$(this).find("witness").each(function(){if(this.hasAttribute("xml:id")){const t=this.getAttribute("xml:id");if(n in e||(e[n]={}),t in e[n]){let e=!0;e&&j(t)}else e[n][t]={tag:this.nodeName.toLowerCase(),type:this.hasAttribute("type")?this.getAttribute("type"):void 0,wits:[],text:this.textContent,node:this},H=!0}})}),function(){let n=1;const a=z;if(y.find("listApp").each(function(){$(this).find("app").each(function(){const t=$(this);t.find("rdg").each(function(){const o=this,i=$(this).attr("wit");i?i.split(" ").forEach(function(t){const i=t.replace(/^#/,"");i in e[a]&&e[a][i].wits.push({n:n,elem:o})}):(console.error("<rdg> without @wit found!"),console.error(t))}),t.find("lem").each(function(){X=!0;const t=this;($(this).attr("wit")||"本文").split(" ").forEach(function(o){const i=o.replace(/^#/,"");i in e[a]&&e[a][i].wits.push({n:n,elem:t})})}),n++})}),y.find("body").each(function(){$(this).find("app").each(function(){const t=$(this),o=Math.random().toString(16).substr(2,9);t.attr("data-temp-app",o),t.find("rdg,.rdg").each(function(){const i=$(this),s=this,c=i.closest("app").attr("data-temp-app");if(o===c){const o=i.attr("wit");o?o.split(" ").forEach(function(t){const o=t.replace(/^#/,"");o in e[a]&&e[a][o].wits.push({n:n,elem:s})}):(console.error("<rdg> without @wit found!"),console.error(t))}}),t.find("lem,.lem").each(function(){X=!0;const t=$(this),i=this,s=t.closest("app").attr("data-temp-app");o===s&&(t.attr("wit")||"本文").split(" ").forEach(function(t){const o=t.replace(/^#/,"");o in e[a]&&e[a][o].wits.push({n:n,elem:i})})}),t.removeAttr("data-temp-app"),n++})}),H){const n=$("#versions");if(n.append(b("テキストの再構成")),Object.keys(e).length>0){const a=e[z];let o=0;{const t="本文",e=$("<div>").addClass("form-check"),a=$("<input>").addClass("form-check-input").attr({type:"radio",name:"versionRadios",id:"versionRadios"+o,value:""}).prop("checked",!0),i=$("<label>").addClass("form-check-label").attr({for:"versionRadios"+o}).text(t);e.append(a).append(i),n.append(e),X||(a.prop("disabled",!0),e.hide())}for(const t in a){o++;const e=f(t,{witnessSelectorTempName:z}),a=$("<div>").addClass("form-check"),i=$("<input>").addClass("form-check-input").attr({type:"radio",name:"versionRadios",id:"versionRadios"+o,value:t}),s=$("<label>").addClass("form-check-label").attr({for:"versionRadios"+o}).text(e);a.append(i).append(s),n.append(a)}t.showVersions||n.hide()}}}();const Y="facsimile_facs_text",W="facsimile_facs_bottom";function B(t){let e,n;{const n=($(t).attr("width")||"").match(/([-+]?\d+(:?\.\d+)?)px/);n&&(e=parseFloat(n[1]))}{const e=($(t).attr("height")||"").match(/([-+]?\d+(:?\.\d+)?)px/);e&&(n=parseFloat(e[1]))}return e>0&&n>0?{width:e,height:n}:void 0}function G(t,a,o){if($.isPlainObject(o)&&t.hasAttribute("xml:id")){const i=$(t).attr("xml:id");if(a in e||(e[a]={}),i in e[a]){let t=!0;const n=e[a][i];n.manifest&&!o.manifest&&(t=!1),t&&j(i)}else{const s=[];{const t=n[Y];if(t&&i in t)for(const e of t[i]){const t=w();s.push({id:t,elem:e.elem});const n=$("<button>").attr("type","button").addClass("btn btn-sm btn-light artifact fac-image").html('<i class="far fa-image"></i>').attr({id:t,"data-facs-target-xmlid":i});$(e.elem).prepend(n)}}{const t=n[W];if(t&&i in t)for(const e of t[i]){const t=$("<button>").attr("type","button").addClass("btn btn-sm btn-light artifact fac-image").html('<i class="far fa-image"></i>').attr({"data-facs-target-xmlid":i});$(e.elem).prepend(t)}}e[a][i]={tag:t.nodeName.toLowerCase(),type:t.hasAttribute("type")?t.getAttribute("type"):void 0,facses:s,lrx:$(t).attr("lrx"),lry:$(t).attr("lry"),ulx:$(t).attr("ulx"),uly:$(t).attr("uly"),points:$(t).attr("points"),text:"",node:t,xmlid:i},Object.assign(e[a][i],o)}}}$(S).find("TEI > facsimile").each(function(){const e=i;t.xmlidPickupDict[e]="en"===d?"Images":"IIIF画像";const n=$(this).attr("sameAs");if(n){const t=n.split(" ")[0];N(y,"facs",{key:Y}),N(x,"facs",{key:W}),$(this).find("surface").each(function(){const n=$(this),a=n.attr("sameAs"),o={width:parseInt(n.attr("lrx")||0,10),height:parseInt(n.attr("lry")||0,10)};let i,s;n.find("graphic").each(function(){const t=$(this).attr("sameAs");t&&(i=t);const e=B(this);e&&(s=e)});const c={manifest:t,canvas:a,canvasInfo:i,canvasSize:o,canvasInfoSize:s};n.find("zone").each(function(){G(this,e,c)}),G(this,e,c)})}}),$(S).find("TEI > facsimile > surface").each(function(){const e=$(this),n=i;let a,o;if(t.xmlidPickupDict[n]="en"===d?"Images":"画像",N(y,"facs",{key:Y}),N(x,"facs",{key:W}),e.find("graphic").each(function(){if(void 0===a){const t=$(this).attr("url"),e=B(this);e&&(a=t,o=e)}}),a){const t={graphicUrl:a,graphicSize:o};e.find("zone").each(function(){G(this,n,t)}),G(this,n,t)}}),t.useOpenSeadragon&&y.find("[facs],[data-facs]").each(function(){const t=$(this),e=t.attr("facs")||t.attr("data-facs");if(e){const n=e.split(" ");if(n.length>1){let e=[];n.forEach(function(t){e.push(t.replace(/^#/,""))});const a=$("<button>").attr("type","button").addClass("btn btn-sm btn-light artifact facs-image").html('<i class="fas fa-images"></i>');a.attr("data-facs-target-xmlids",e.join(" ")),t.prepend(a)}}});const q=[],V=c!==s.MANYO?"front,body,back":"body";if(y.find(V).each(function(t,e){const n=e.tagName;q.includes(n)||q.push(n);const a=$(e);(function(){const t=["title","l","seg","note","persName","s"];let e;for(const n of t)if("span"!==n)for(e=a.find(n);e.length>0;)e.each(function(){replaceWithElement(this,"span")}),e=a.find(n)})(),function(){const t=["lg","ab"];let e;for(const n of t)if("div"!==n)for(e=a.find(n);e.length>0;)e.each(function(){replaceWithElement(this,"div")}),e=a.find(n)}(),a.find("metamark").each(function(){const t=$(this),e=t.html(),n=this.hasAttribute("function")&&"kaeri"===this.getAttribute("function");if(n&&(v=!0),n&&2===e.length){const n=e[0],a=e[1],o=$("<span>").addClass("metamark").attr("data-function","kaeri").text(n),i=$("<span>").addClass("metamark").attr("data-function","kaeri").text(a);let s;"㆑"===a&&("㆒"===n?o.addClass("oneMark"):"㆖"===n?o.addClass("topMark"):"㆙"===n?o.addClass("firstMark"):"㆝"===n&&o.addClass("heavenMark"),o.addClass("nextIsReverseMark"),i.addClass("reverseMark")),"㆐"===n?s=o:"㆐"===a&&(s=i),s&&s.addClass("tateten").removeAttr("data-function");const c=$("<span>").append(o).append(i);t.replaceWith(c.html())}else{const n=$("<span>").addClass("metamark");n.html(e),copyAttributes(this,n[0]),t.replaceWith(n)}}),a.find(".metamark").each(function(){const t=this.nextSibling;t&&"#text"===t.nodeName&&t.nodeValue&&/^[、。]/.test(t.nodeValue)&&$(this).addClass("nextIsPunctuationMark")}),a.find('span[data-type="wari"].note').each(function(){0===$(this).find("br").length&&$(this).append("<br/>").append($("<span>").addClass("wariSingleLineFiller"))}),c===s.MANYO&&(a.find('.milestone[data-unit="wbr"]').each(function(){$(this).after("<br/>")}),a.find('span[data-type="割書"].note').each(function(){0===$(this).find("br").length&&$(this).append("<br/>").append($("<span>").addClass("wariSingleLineFiller"))})),"body"!==n&&a.find("listPlace").each(function(){$(this).find("place").each(function(){const t=$(this);t.find("location geo").each(function(){const e=$(this).text();if(e){const n=e.match(/(-?[0-9]+(?:\.[0-9]+)?) +(-?[0-9]+(?:\.[0-9]+)?)/);if(n){const e=parseFloat(n[1]),a=parseFloat(n[2]),o=$("<button>").attr("type","button").addClass("btn btn-sm btn-light artifact place-location-geo").html('<i class="fas fa-map-marker-alt"></i>').attr({"data-lat":e,"data-lng":a});t.append(o)}}})})});let o='<div class="'+n+'">'+e.innerHTML+"</div>";c===s.DEFAULT&&(o=(o=o.replace(/&amp;T[0-9]{6};/g,"〿")).replace(/&amp;MT[0-9]{5};/g,"〿"));const i=(new DOMParser).parseFromString(o,"application/xml");c===s.MANYO&&preprocessInlineNote(i,h,["割書","送り"],[],E);const l=showAppPlace(i,h,m,!1,E);c===s.MANYO&&postprocessInlineNote(i);const d=(new XMLSerializer).serializeToString(i),u=$(d);let f;k.append(u),g.append(k);const b={};c===s.MANYO&&(r="",u.find("subst").each(function(){const t=$(this);let e=0;t.find("del").each(function(){e=$(this).text().length;const t=this.getAttribute("type")||this.getAttribute("data-type");t&&(this.title=t)}),t.find("add").each(function(){const t=$(this).text().length;$(this).css({top:-e+"em","margin-bottom":-t+"em"});const n=this.getAttribute("type")||this.getAttribute("data-type");n&&(this.title=n)})}),u.find(".note").each(function(t,e){const n=$(e),a=getCjkDecimal(P),o=n.attr("data-target"),i=o||n.attr("xml:id"),s=n.attr("data-targetend"),c=n.attr("data-type")||"",l=n.attr("data-subtype"),d=n.attr("data-place"),h="("+P+") ",m=c+(l?" "+l:""),g=n.attr("data-n");if(g&&parseInt(g,10)!==P){const t="脚注番号"+P+"（"+n.attr("xml:id")+"）以降にズレが生じています。";console.log(t),f||($("#errors").append($("<div>").addClass("color-red").text(t)),f=!0)}if(i&&s){n.attr("title",h+m);const t=c?"［"+c+"］":c,o=$(e.cloneNode(!0));o.find("add").each(function(){$(this).removeAttr("style")});const i=R({eliminateSelector:".note"});F(o,i),r+='<div class="app" data-n="'+String(P)+'"><div class="appnum" title="クリックでハイライト切り替え">'+a+'</div><div class="note">'+t+o.html()+"</div></div>",p&&console.debug(String(P)+"："+n.text()+" → "+u.find(".ct[data-n='"+String(P)+"']").text()+" "+n.attr("xml:id")),P++}else if(n.attr("title",m),s){const t="<note>要素「"+n.text()+"」は、xml:idまたは範囲の始まりが設定されていません。";console.log(t),$("#errors").append($("<div>").addClass("color-red").text(t))}if(c&&c.match(M)){const t=D(o),e=$("#"+t),n=$("<span>").attr("id",I(o));e.after(n)}g&&(b[g]={place:d,type:c})}),u.find("span.ct").each(function(t,e){const n=e.getAttribute("data-n");if(n){const t=b[n];t&&(t.place&&e.setAttribute("data-note-place",t.place),t.type&&e.setAttribute("data-note-type",t.type))}}),""!==r&&(C=!0,x.addClass("display-none"),x.append(r),x.removeClass("display-none")));for(let t of l){let e=getCjkDecimal(t.anchorNo);"appToNotFound"===t.type?e+="：範囲の終わり "+t.appTo+" がありません":"duplicate"===t.type&&(e+="：範囲の始まり "+t.appFrom+" と終わり "+t.appTo+" が同一のもの（"+getCjkDecimal(t.anchorNoRef)+"）があります"),$("#errors").append($('<div style="font-size:1em">').attr({"data-n":t.anchorNo}).addClass("ft app").text(e))}}),q.includes("front")||q.includes("back")){const e=$("#textstructures");e.append(b("テキスト構造"));const n=$("<div>"),a=$("<div>").addClass("row align-items-center");let o=0;const i=["body"];c!==s.WAKASHUU&&c!==s.UTAAWASE||i.push("back");for(const t of q){if(t){let e=t;const n="textstructureChecks"+o,s=$("<div>").addClass("col col-auto"),c=$("<div>").addClass("form-check"),l=$("<input>").addClass("form-check-input").attr({type:"checkbox",name:"textstructureChecks",id:n,value:t}).prop("checked",i.includes(t)),r=$("<label>").addClass("form-check-label").attr({for:n}).text(e);c.append(l).append(r),s.append(c),a.append(s)}o++}n.append(a),e.append(n),$("#textstructures").on("change",'input[name="textstructureChecks"]:checkbox',function(){const t=$(this).val();if(t){const e=$(".text > ."+t);$(this).prop("checked")?e.removeClass("display-none"):e.addClass("display-none")}}),t.showTextStructures||e.hide()}const K=[["sic","corr"],["orig","reg"]],Z=[!1,!1];if(y.find("choice").each(function(){let t=0;for(const e of K){for(const n of e)$(this).find(n).length>0&&(Z[t]=!0);t++}}),Z.includes(!0)){const e=$("#choice");e.append(b("Choice"));const n=$("<div>");let a=0;for(const t of Z){const e=K[a];if(t){const t=$("<div>").addClass("row align-items-center");let o=e.join("/");const i=$("<label>").addClass("col col-form-label py-0").text(o);t.append(i);let s=0;for(const o of e){let e=o;const i="choiceRadios"+a+"_"+s,c=$("<div>").addClass("col"),l=$("<div>").addClass("form-check"),r=$("<input>").addClass("form-check-input").attr({type:"radio",name:"choiceRadios"+a,id:i,value:o,"data-choice-part-tags-index":a}).prop("checked",0===s),d=$("<label>").addClass("form-check-label").attr({for:i}).text(e);l.append(r).append(d),c.append(l),t.append(c),n.append(t),s++}}a++}e.append(n),$("#choice").on("change",'input[name^="choiceRadios"]:radio',function(){const t=$(this).val();if(t){const e=parseInt($(this).attr("data-choice-part-tags-index"),10),n="choice-highlight";for(const a of K[e]){const e=$(".body-result,.bottom-result").find(a);t===a?(A||e.addClass(n),e.removeClass("display-none"),A||setTimeout(function(){e.removeClass(n)},100)):(A||e.removeClass(n),e.addClass("display-none"))}c===s.MANYO&&U()}}),t.showChoice||e.hide()}}),$('input[name="textstructureChecks"]:checkbox').change(),$('input[name^="choiceRadios"]:radio:checked').change(),t.enableFileDescTab){const t="fileDescTab",e=Y(t,"書誌");$("#main_tab").append(e.tab),$("#main_tab_content").append(e.tabPane);const n=e.tabPaneContent,a=$("<div>").addClass("pe-2 overflow-y-auto flex-grow-1");_&&a.append(_),L&&a.append(L),n.append(a)}if(t.enableXmlidListPickup&&Object.keys(a).length>0){const e="xmlidlists",n=Y(e,"一覧");$("#main_tab").append(n.tab),$("#main_tab_content").append(n.tabPane),setTimeout(function(){const o=n.tabPaneContent,i=$("<ul>").addClass("nav nav-tabs").attr({role:"tablist"}),l=$("<div>").addClass("tab-content");let r=1;for(const n in a){const o=t.xmlidListPickupDict[n]||n,d=W(e,o,r);i.append(d.tab),l.append(d.tabPane);const p=a[n];let h="";for(const e of p){const a=D(e),o=$("#"+a);let i;if(t.xmlidListPickupOption[n].contentSelector)i=o.attr(t.xmlidListPickupOption[n].contentSelector);else if(c===s.MANYO){const e=o.clone();let a=t.xmlidListPickupOption[n];const s=R(a);F(e,s),i=e.text()}else i=o.text();const l=document.createElement("li");let r="list-group-item xmlid-list-item";t.xmlidListPickupOption[n].truncate&&(r+=" text-truncate"),l.className=r,l.setAttribute("data-listed-id",a),l.textContent=i;const d=l.outerHTML;h+=d}const u='<div><ul class="list-group list-group-flush">'+h+"</ul></div>";d.tabPane.html(u),r++}o.append(i).append(l)},0)}if(Object.keys(e).length>0){const n="xmlidrefs",a=Y(n,"参照関係");$("#main_tab").append(a.tab),$("#main_tab_content").append(a.tabPane),setTimeout(function(){const o=a.tabPaneContent;c!==s.MANYO&&o.append(b("xml:id"));const i=$("<ul>").addClass("nav nav-tabs").attr({role:"tablist"}),l=$("<div>").addClass("tab-content");let r=1;for(const a in e){const o=t.xmlidPickupDict[a]||a,s=W(n,o,r);i.append(s.tab),l.append(s.tabPane);const c=e[a];let d=!1,p="",h=1;for(const t in c){const e=n+"_accordion_collapse_"+r+"_"+h,o=c[t],i=o.corresps,s=o.sameAses,l=o.wits,u=o.facses,g=o.targets,b=i?i.length:0,y=s?s.length:0,x=l?l.length:0,v=u?u.length:0,C=g?g.length:0,A=b+y+x+v+C,k=f(t,{selector:a,rubyEliminate:!0,notAppendXmlId:!0}),w=document.createElement("span");w.className="xmlid-on-header",w.setAttribute("data-target-xmlid",t),w.textContent=t;const N=w.outerHTML,S='<span class="flex-fill bold">'+k+"（"+N+"）</span>",E=z(t,a);let T="";for(const t of E){const e=document.createElement("a");e.className="ms-1",e.setAttribute("href",t.url),e.setAttribute("target","_blank"),e.setAttribute("title",t.type),e.innerHTML='<i class="fas fa-external-link-alt"></i>';const n=e.outerHTML;T+=n}const _='<span class="badge bg-primary rounded-pill float-end mx-2">'+A+"</span>",L=S+T+_,O=document.createElement("button");O.className="accordion-button collapsed focus-ring focus-ring-light",O.setAttribute("type","button"),O.setAttribute("data-bs-toggle","collapse"),O.setAttribute("data-bs-target","#"+e),O.innerHTML=L;const M=O.outerHTML,P='<h2 class="accordion-header">'+M+"</h2>";let D="";if(A){D='<div class="mb-2">参照している箇所</div>';let t="";if(b){t="";for(const e of i){const n=m(e.elem),a=document.createElement("li");a.className="list-group-item xmlid-ref-list-item",a.setAttribute("data-ref-id",e.id),a.textContent=n;const o=a.outerHTML;t+=o}D+='<ul class="list-group" data-ref-type="corresp">'+t+"</ul>"}if(y){t="";for(const e of s){const n=m(e.elem),a=document.createElement("li");a.className="list-group-item xmlid-ref-list-item",a.setAttribute("data-ref-id",e.id),a.textContent=n;const o=a.outerHTML;t+=o}D+='<ul class="list-group" data-ref-type="sameas">'+t+"</ul>"}if(x){t="";for(const e of l){const n=m(e.elem),a=document.createElement("li");a.className="list-group-item wit-list-item",a.setAttribute("data-n",e.n),a.textContent=n;const o=a.outerHTML;t+=o}D+='<ul class="list-group">'+t+"</ul>"}if(v){t="";for(const e of u){const n='<i class="far fa-image"></i>',a=document.createElement("li");a.className="list-group-item xmlid-ref-list-item",a.setAttribute("data-ref-id",e.id),a.innerHTML=n;const o=a.outerHTML;t+=o}D+='<ul class="list-group" data-ref-type="facs">'+t+"</ul>"}if(C)if(d){D="";const t='<div class="mb-2">参照している箇所</div>',e='<div class="my-2">解説</div>',n=[t,e],a=["",""];for(const t of g){let e=0;const n=$("#"+t.id);if(n){const t=n.parent()[0];t&&"notegrp"===t.tagName.toLowerCase()&&t.hasAttribute("type")&&"解説"===t.getAttribute("type")&&(e=1)}let o=m(t.elem);if(1===e){const t=n.attr("data-resp");t&&(o+="（"+t.replace(/#/,"")+"）")}const i=document.createElement("li");i.className="list-group-item xmlid-ref-list-item",i.setAttribute("data-ref-id",t.id),i.textContent=o;const s=i.outerHTML;a[e]+=s}for(let t=0;t<n.length;t++)a[t].length&&(D+=n[t],D+='<ul class="list-group" data-ref-type="target">'+a[t]+"</ul>")}else{t="";for(const e of g){const n=m(e.elem),a=document.createElement("li");a.className="list-group-item xmlid-ref-list-item",a.setAttribute("data-ref-id",e.id),a.textContent=n;const o=a.outerHTML;t+=o}D+='<ul class="list-group" data-ref-type="target">'+t+"</ul>"}}const I=document.createElement("div");I.className="accordion-collapse collapse",I.setAttribute("id",e),I.innerHTML='<div class="accordion-body">'+D+"</div>";const U=I.outerHTML,j='<div class="accordion-item">'+P+U+"</div>";p+=j,h++}const u='<div class="accordion accordion-flush">'+p+"</div>";s.tabPane.html(u),r++}o.append(i).append(l)},0)}function z(t,n){const a=[];if(n){const o=e[n];t in o&&$(o[t].node).find("idno").each(function(){const t=$(this).attr("type"),e=$(this).text();if(e)if(/^https?:\/\//.test(e))a.push({url:e,type:t});else{let n;"DOI"===t?n="https://doi.org/":"VIAF"===t&&(n="https://viaf.org/viaf/"),n&&a.push({url:n+e,type:t})}})}return a}t.enableSearch&&function(){const t=Y("search","検索");$("#main_tab").append(t.tab),$("#main_tab_content").append(t.tabPane);const n=t.tabPaneContent,a=$("<div>").addClass("tab-pane-content");n.append(a);const o=$("<div>").addClass("input-group mb-3"),i=$("<input>").addClass("form-control").attr({type:"text",name:"searchText"}),s=$("<button>").addClass("btn btn-outline-secondary").attr({type:"button",id:"search_button"}).text("検索");o.append(i).append(s),a.append(o);const c=$("<div>"),l=$("<div>");let r=0;const d={};for(const[t,e]of Object.entries(O)){const n="searchConds"+r,a=X(n,e.label||t,t,e.checked,"searchConditions",!0);if(e.hidden&&a.hide(),c.append(a),a.on("change",H),e.subConditions){const a=$("<span>").addClass("me-2").text(t+"："),o=$("<div>").append(a),i="searchConditions"+r+"Sub";d[t]=i;let s=0;for(const[t,n]of Object.entries(e.subConditions)){const e="searchConds"+r+"Sub"+s,a=X(e,n.label||t,t,n.checked,i,!0);n.hidden&&a.hide(),o.append(a),s++}e.checked?o.show():o.hide(),$("#right_panel").on("change","#"+n,function(){$(this).prop("checked")?o.show():o.hide()}),l.append(o)}r++}if(r>=5){const t=$("<button>").attr({id:"search_conditions_all_check_uncheck",type:"button"}).addClass("btn btn-outline-secondary btn-sm");t.on("click",function(){const t=!(0===$('input[type="checkbox"][name="searchConditions"]:not(:checked)').length);$('input[type="checkbox"][name="searchConditions"]').prop("checked",t).change()}),c.append(t)}a.append(c).append(l),H();const p=$("<div>").addClass("mt-2").attr({id:"serach_result_count"});a.append(p);const h=$("<div>").attr({id:"serach_result"}).addClass("overflow-y-auto");a.append(h),s.on("click",function(){p.empty(),h.empty();let t=0;const n=$("<ul>").addClass("list-group list-group-flush border"),a=i.val(),o=new RegExp(a,"iu"),s=[],c={};$('input[type="checkbox"][name="searchConditions"]:checked').each(function(){const t=$(this).val();if(t in O){const o=O[t],i=[];if(o.subConditions){const e=d[t];e&&$('input[type="checkbox"][name="'+e+'"]:checked').each(function(){const t=$(this).val(),e=o.subConditions[t];e.selector&&i.push(e.selector)})}const l=i.join(",");if(o.persName&&"person"in e)if(t in c||(c[t]=[]),a in e.person){let n=!0;l&&0===$("<div>").append(e.person[a].node).children(l).length&&(n=!1),n&&c[t].push(a)}else $(".body-result").find(".persname").each(function(){n(this,l,!0)}),0===c[t].length&&$(".body-result").find(".persname").each(function(){n(this,l,!1)});let r=o.selector;!o.persName&&l&&(r=l),r&&s.push(r)}function n(n,o,i){const s=$(n).clone(),l=R();F(s,l);const r=s.text();let d;if(d=i?!(r!==a):r.includes(a)){let n=s.attr("data-corresp");if(n&&(n=n.replace(/^#/,""))){let a=!0;n in e.person&&o&&0===$("<div>").append(e.person[n].node).children(o).length&&(a=!1),a&&(c[t].includes(n)||c[t].push(n))}}}});const l={};$('input[type="checkbox"][name="searchConditions"]:checked').each(function(){const t=$(this).val();if(t in O){const e=O[t],n=[];if(e.subConditions){const a=d[t];a&&$('input[type="checkbox"][name="'+a+'"]:checked').each(function(){const t=$(this).val(),a=e.subConditions[t];a.selector&&n.push(a.selector)})}const a=n.join(",");let o=e.selector;!e.persName&&a&&(o=a),o&&$(".body-result").find(o).each(function(){const e=getElementXPath(this);e in l||(l[e]=t)})}});const r=s.join(","),u={};$(".body-result").find(r).each(function(){const e=$(this).clone(),a=getElementXPath(this);if(a in u)return;let i,s={};a in l&&(i=l[a])&&(s=O[i]);const r=R(s);F(e,r);let d=void 0;if(s.persName&&(d=!1,i in c))for(const t of c[i]){const n=e.attr("data-corresp")||e.attr("corresp")||e.attr("data-resp")||e.attr("resp");if(t&&n){const e=n.split(" ");e.includes("#"+t)&&(d=!0)}}const p=e.text();if(void 0===d)try{d=p.match(o)}catch(t){console.log(t)}if(d){const e=$(this);let o=p;if(s.resultXPathSelector){const t=e.xpath(s.resultXPathSelector);if(t&&t.length){const e=t.clone();F(e,r),o=e.text()}}const c=$("<li>").addClass("list-group-item").text(o),l=e.attr("data-type");if(l){let t=l;const n=e.attr("data-subtype");n&&(t+=" "+n),c.attr("title",t)}c.on("mouseover mouseout",function(t){const n="mouseover"===t.type;k(n,$(this),e,"xmlids-highlight","target-highlight")}),n.append(c),t++,u[a]=i}});const f=$("<div>").addClass("my-2").text("検索結果："+t+"件");p.append(f),t&&h.append(n),$("#serach_result").mark(a)}),i.on("keyup",function(t){13===t.which&&s.click()})}();function R(t){let e=".artifact,.note,rt,rdg,.rdg,del";if(t&&("eliminateSelector"in t?e=t.eliminateSelector:"additionalEliminateSelector"in t&&(e=".artifact,.note,rt,rdg,.rdg,del,"+t.additionalEliminateSelector),"notEliminateSelector"in t)){const n=e.split(","),a=t.notEliminateSelector.split(","),o=[];for(const t of n){const e=t.trim();let n=!0;for(const t of a){const a=t.trim();if(e===a){n=!1;break}}n&&o.push(e)}e=o.join(",")}return e}function F(t,e){return e&&t.find(e).each(function(){$(this).empty()}),t.find("sic,corr,orig,reg").each(function(){$(this).hasClass("display-none")&&$(this).empty()}),t}function H(){const t=0===$('input[type="checkbox"][name="searchConditions"]:not(:checked)').length?"全解除":"全選択";$("#search_conditions_all_check_uncheck").text(t)}if(t.showLegends){const t=$("#legends").append(b("凡例"));let e=[];e=c===s.MANYO?[{text:"合点",class:"manyo-note-gatten",selector:'.note[data-type="合点"]'},{text:"注",class:"manyo-note-cyuu",selector:'.note[data-type="注"]'},{text:"異文",class:"manyo-note-ibun",selector:'.note[data-type="異文"]'},{text:"送り",class:"manyo-note-okuri",selector:'.note[data-type="送り"]'},{text:"異訓",class:"manyo-note-ikun",selector:'.note[data-type="異訓"]'},{text:"訓",class:"manyo-note-kun",selector:'.note[data-type="訓"]'}]:[{text:"<persName>",class:"persname",selector:".persname"},{text:"<app>",class:"ct",selector:".ct"},{text:"<app>",class:"ct-no-highlight",selector:".ct"},{text:"<note>",class:"note-hover",selector:".note"},{text:"@corresp",class:"corresp-highlight",selector:"[corresp],[data-corresp]"},{text:"@sameAs",class:"sameas-highlight",selector:"[sameAs],[data-sameas]"},{text:"<figure>",class:"figure-highlight",selector:"figure"},{text:"<l>",class:"l",selector:".l"}];let n=!1;for(const a of e){const e=g.find(a.selector).length;if(e){const e=$("<span>").text(a.text).addClass(a.class).addClass("me-2");t.append(e),n=!0}}n||t.hide()}(c===s.WAKASHUU||c===s.UTAAWASE||v||C)&&$("#additionalUIs").append(b("表示オプション"));if(v){const t=X("checkbox-kunten","訓点を表示",'.metamark[data-function="kaeri"]',!0);$("#additionalUIs").append(t)}if(C)if(c===s.MANYO);else{const t=X("checkbox-footnote","脚注を表示","#bottom_result",!0);$("#additionalUIs").append(t)}else x.hide();if(t.aboutUrl){$("#help").append(b("ヘルプ"));const e=$("<a>").attr({target:"_blank",href:t.aboutUrl}).text("このビューワについて");$("#help").append(e)}t.enableBodyResize&&($("#text_body").resizable({handles:"s"}),$("#text_bottom").addClass("text-body-resizable"));$("#left_col").removeClass("order-1"),A=!1,c===s.MANYO&&setTimeout(function(){U()},0);function X(t,e,n,a,o,i,s){const c=$("<div>").addClass("form-check");i&&c.addClass("form-check-inline");const l=s||"checkbox",r=$("<input>").addClass("form-check-input").attr({type:l,id:t,value:n});o&&r.attr({name:o}),a&&r.prop({checked:!0});const d=$("<label>").addClass("form-check-label").attr({for:t}).text(e);return c.append(r).append(d),c}function Y(t,e){const n=$("<li>").addClass("nav-item").attr({role:"presentation"}),a=t+"_tab",o=t+"_tab_pane",i=$("<button>").addClass("nav-link").attr({id:a,"data-bs-toggle":"tab","data-bs-target":"#"+o,type:"button",role:"tab","aria-controls":o,"aria-selected":!1}).text(e);n.append(i);const s=$("<div>").addClass("tab-pane fade top-tab-pane").attr({id:o,role:"tabpanel","aria-labelledby":a,tabindex:0}),c=$("<div>").addClass("my-2 tab-pane-content").attr({id:t});return s.append(c),{tab:n,tabPane:s,tabPaneContent:c}}function W(t,e,n){const a=$("<li>").addClass("nav-item").attr({role:"presentation"}),o=t+"_tab_"+n,i=t+"_tab_pane_"+n,s=$("<button>").addClass("nav-link").attr({id:o,"data-bs-toggle":"tab","data-bs-target":"#"+i,type:"button",role:"tab","aria-controls":i,"aria-selected":!1}).text(e);1===n&&s.addClass("active"),a.append(s);const c=$("<div>").addClass("tab-pane fade sub-tab-pane").attr({id:i,role:"tabpanel","aria-labelledby":o,tabindex:0});return 1===n&&c.addClass("show active"),{tab:a,tabPane:c}}})(o,h).then(()=>{u.stop()})}function u(t,e,n){const a=$(t),o=a.find(e+'[type="main"]');if(o.length)return n.rubyEliminate?m(o[0]):$(o[0]).text();const i=a.find(e);return i.length?n.rubyEliminate?m(i[0]):$(i[0]).text():void 0}function f(t,n){const a=n||{};function o(t,a){const o=e[t];if(a in o){let e;e=n.rubyEliminate?m(o[a].node):o[a].text;let i=t;const s=t.replace(">"," ").split(" ");return s.length>0&&(i=s[s.length-1]),"person"===i?e=u(o[a].node,"persName",n):"place"===i&&(e=u(o[a].node,"placeName",n)),e}}let i="";if(a.selector)i=o(a.selector,t);else for(const n in e)if(i=o(n,t))break;return t&&(i||(i=""),i&&a.insertBreakBeforeXmlId&&(i+="\n"),a.notAppendXmlId||(i+="（"+t+"）")),i}function m(t){return g(t,["rt","rdg,.rdg",".artifact"])}function g(t,e){const n=$(t).clone();for(const t of e)t&&n.find(t).each(function(){$(this).text("")});return n.text()}function b(t){return $("<div>").addClass("heading1").text(t)}function y(t){return $("<div>").addClass("heading2").text(t)}function x(t){v(document.querySelector(t))}function v(t){if(t){const e=$(t).closest(".body-result,.bottom-result");if(e.length){const n=e[0],a=t.getBoundingClientRect(),o=n.getBoundingClientRect(),i=0;let s=0;if("vertical-rl"===$(t).css("writing-mode")){s=o.width<a.width?o.width*(1-i)-a.width:(o.width-a.width)/2;const t=a.left-o.left-s;n.scrollBy({left:t,top:0,behavior:"smooth"})}else{s=o.height<a.height?o.height*i:(o.height-a.height)/2;const t=a.top-o.top-s;n.scrollBy({left:0,top:t,behavior:"smooth"})}}}}function C(t,e){{const n=".manyo span.ct",a=n+"[data-n='"+t+"']",o="ct-no-highlight";$(n).removeClass(o),e&&$(a).addClass(o)}{const n=".manyo span.note",a=n+"[data-n='"+t+"']",o="note-highlight";$(n).removeClass(o),e&&$(a).addClass(o)}{const n=".app",a=n+"[data-n='"+t+"']",o="app-highlight";$(n).removeClass(o),e&&$(a).addClass(o)}}$(".file_input1").change(function(){$('#input1 input[type="file"]').hide();for(let t=0;t<this.files.length;++t)if("text/xml"===this.files[t].type){$("#input1").append(this.files[t].name);const e=new FileReader;e.onload=function(t){h(t)},e.readAsText(this.files[t],"UTF-8");break}}),$("body").on("click mouseover mouseout",".ft",function(t){const e=".app[data-n='"+$(this).attr("data-n")+"']";$(".app").removeClass("app-highlight"),"click"===t.type&&x(e),"click"!==t.type&&"mouseover"!==t.type||$(e).addClass("app-highlight")}),$("body").on("click mouseover mouseout",".appnum",function(t){const e=$(this).closest(".app").attr("data-n"),n="app-highlight";{const a=".ct",o=a+"[data-n='"+e+"']";if($(a).removeClass(n),"click"===t.type){x(o);const t=$(this).find(".cthltgl"),e="ct-no-highlight";$(o).toggleClass(e),$(o).hasClass(e)?t.html('<span class="ui-icon ui-icon-radio-off"></span>'):t.html('<span class="ui-icon ui-icon-radio-on"></span>')}"click"!==t.type&&"mouseover"!==t.type||$(o).addClass(n)}{const a=".ft",o=a+"[data-n='"+e+"']";$(a).removeClass(n),"click"!==t.type&&"mouseover"!==t.type||$(o).addClass(n)}}),$("body").on("mouseover mouseout",".note",function(t){if(c===s.MANYO){t.stopPropagation();let e=$(this).attr("data-n");e||(e=$(this).closest(".app").attr("data-n")),C(e,"mouseover"===t.type)}}),$("body").on("click",".note",function(t){if(c===s.MANYO){let e,n=$(this).attr("data-n");if(n||(n=$(this).closest(".app").attr("data-n"),e=!0),!e){t.stopPropagation();const e=".app"+"[data-n='"+n+"']",a="app-highlight";$(e).addClass(a),x(e)}}}),$("body").on("mouseover mouseout",".ct",function(t){if(c===s.MANYO){C($(this).attr("data-n"),"mouseover"===t.type)}}),$("body").on("click",".ct",function(){if(c===s.MANYO){const t=".app",e=t+"[data-n='"+$(this).attr("data-n")+"']",n="app-highlight";$(t).removeClass(n),$(e).addClass(n),x(e)}}),$("#right_col").on("click","#checkbox-kunten,#checkbox-footnote,#checkbox-win-or-lose,#checkbox-kokkataikannum",function(){const t=$(this).prop("checked"),e=$($(this).val());t?e.removeClass("display-none"):e.addClass("display-none")});const A={};function k(t,e,n,a,o){t?(e.addClass(a),n.addClass(o),n.length&&v(n[0])):(e.removeClass(a),n.removeClass(o))}function w(){let t;do{t=Math.random().toString(16).substr(2,8)}while(t in o);return o[t]=!0,t}function N(t,e,a){const o=a||{},i=o.key||e;n[i]={};const s=e.toLowerCase();let c="["+e+"]";o.noNeedForData||(c+=",[data-"+s+"]"),t[0].querySelectorAll(c).forEach(function(t){const a=t.getAttribute(e)||t.getAttribute("data-"+s);if(a){const e=a.split(" ");if(e.length){let a;t.id?a=t.id:(a=w(),t.id=a),e.forEach(function(e){if(e&&(e=e.replace(/^#/,""))){const o={id:a,elem:t};e in n[i]?n[i][e].push(o):n[i][e]=[o]}})}}})}function S(t,e,n){let a=$();return t[0].querySelectorAll("["+n+'~="#'+e+'"],[data-'+n+'~="#'+e+'"]').forEach(function(t){a=a.add(t)}),a}$("#right_col").on("change",'input[name="versionRadios"]:radio',function(){const t=$(this).val(),e="#"+t;0===Object.keys(A).length&&$("#bottom_result").children(".app[data-n]").each(function(){const t=$(this).attr("data-n");$(".ct[data-n='"+t+"']").each(function(){return t in A||(A[t]=$(this).html()),!1})});let n=!1;$("#bottom_result").children(".app[data-n]").each(function(){const a=$(this),o=a.attr("data-n"),i=t?a.children('.rdg[data-n="'+o+'"][data-wit~="'+e+'"]'):[],s=i.length?i:a.find('.lem[data-n="'+o+'"]');let c="";s.length?s.each(function(){$(this).children(".footnote-content").each(function(){c=$(this).html()})}):(c=A[o]||"",n=!0);$(".ct[data-n='"+o+"']").each(function(){$(this).html(c)})}),n&&$('input[name^="choiceRadios"]:radio:checked').change()}),$("#right_col").on("mouseover mouseout",".xmlid-on-header",function(t){const e=$(this).attr("data-target-xmlid"),n="mouseover"===t.type,a=$("body").find('[xml\\:id="'+e+'"]');k(n,$(this),a,"xmlids-highlight","xmlids-highlight")}),$("#right_col").on("mouseover mouseout",".xmlid-list-item",function(t){const e=$(this).attr("data-listed-id"),n="mouseover"===t.type,a=$("#"+e);k(n,$(this),a,"xmlids-highlight","xmlids-highlight")}),$("#right_col").on("mouseover mouseout",".xmlid-ref-list-item",function(t){const e=$(this).attr("data-ref-id"),n="mouseover"===t.type,a=$("#"+e),o=$(this).parent().attr("data-ref-type")+"-highlight";k(n,$(this),a,"xmlids-highlight",o)}),$("#right_col").on("mouseover mouseout",".wit-list-item",function(t){const e=$(this).attr("data-n"),n=$("body").find('.ct[data-n="'+e+'"],.ft[data-n="'+e+'"]');k("mouseover"===t.type,$(this),n,"xmlids-highlight","wit-highlight")});let E=0;const T={};function _(e,n,a,o,i,s){if(e){if($(n).addClass(s),a.addClass(s),t.enableGraph){const t=i?n:a,s=i?a:n,c=function(t,e,n){"length"in t||(t=[t]);"length"in e||(e=[e]);const a=t.length,o=e.length;let i=[];i=$.isArray(n)?n:[n];let s=i;for(const t of e)if(t){const e=$(t).attr("xml:id");if(e){const t=s.filter(t=>t!==e);s=t}}const c=(i=s).length;let l;if(a>0&&o+c===1){let n="";const a=1===o?e[0]:void 0;1===o&&(l=$(a).attr("xml:id")),l||1!==c||(l=i[0]);const s=O(a,l);for(const e of t){const t=O(e),a=M(e);n+=' "'+t+'" -> "'+s+'" '+a+" \n"}let r="digraph {";return r+="bgcolor=transparent ",r+="rankdir=LR ",r+=n,r+="}",n?r:""}if(1===a&&o+c>1){let n="";const a=t,o=O(a),s=M(a);for(const t of e){l=t?$(t).attr("xml:id"):i.shift();const e=O(t,l);n+=' "'+o+'" -> "'+e+'" '+s+" \n"}for(const t of i){const e=O(void 0,t);n+=' "'+o+'" -> "'+e+'" '+s+" \n"}let c="digraph {";c+="bgcolor=transparent ",c+="rankdir=LR ",c+=n,c+="}";const r=n?c:"";return r}return""}(t,s,o);if(c){const t="xmlidgraph"+E;$(n).attr("data-graphid",t),E++;const e=$("<div>").attr({id:t,role:"alert"}).addClass("dotgraph alert alert-light alert-dismissible fade show mt-2 mb-0");document.documentElement.scrollHeight>document.documentElement.clientHeight||$("body").addClass("overflow-y-hidden"),$("#graph_result").prepend(e),d3.select("#"+t).graphviz({zoom:!1}).renderDot(c).on("end",function(){e.append('<button type="button" class="btn-close" aria-label="Close"></button>'),e.append('<button type="button" class="btn svglink" title="グラフの保存（SVG）"><i class="fas fa-download"></i></button>'),e.append('<button type="button" class="btn pnglink" title="グラフの保存（PNG）"><i class="far fa-file-image"></i></button>')})}D(e,t,s)}}else $(n).removeClass(s),a.removeClass(s),t.enableGraph&&($("#graph_result").find(".dotgraph").each(function(){const t=$(this).attr("id");t in T||(d3.select("#"+t).selectAll("svg").remove(),d3.select("#"+t).graphviz().destroy(),$(this).remove())}),$("body").removeClass("overflow-y-hidden"),D(e))}function O(t,e){let n=t?g(t,["rt","rdg,.rdg",".artifact"]):"";if(n&&(n=n.replace(/\n+/g,"\n").replace(/ +/g," ")),n){const t=n.match(/.{1,20}/g);t&&(n=t.join("\n"))}return e&&(n?n+="\n（"+e+"）":n=f(e,{insertBreakBeforeXmlId:!0}),n||(n="（"+e+"）")),n}function M(e){let n="";if(e){$.isArray(e)&&e.length>0&&(e=e[0]);const a=$(e);let o=a.attr("type")||a.attr("data-type");if(o&&(o in t.typeToGraphLabelMapping&&(o=t.typeToGraphLabelMapping[o]),n='[label="'+o+'"]'),!n){n='[label="'+(a.attr("data-original-tag-name")||e.nodeName.toLowerCase())+'"]'}}return n}const P=[];function D(t,e,n){for(;P.length;){P.pop().remove()}if(e&&n&&t){const t="length"in e?e:[e],a="length"in n?n:[n];for(const e of t)for(const t of a){const n=new LeaderLine(e,t,{color:"rgba(30, 130, 250, 0.2)"});P.push(n)}}}function I(t,e,n){const a=e.toLowerCase(),o=$(t).attr(e)||$(t).attr("data-"+a);if(o){const e=[],i=[];o.split(" ").forEach(function(t){const n=t.replace(/^#/,"");e.push('[xml\\:id="'+n+'"]'),i.push(n)});const s=$("body").find(e.join(",")),c="mouseover"===n.type,l=!0;s.length&&_(c,t,s,i,l,a+"-highlight")}}$(".body-result").on("mouseover mouseout","[corresp],[data-corresp]",function(t){c!==s.MANYO&&(t.stopPropagation(),I(this,"corresp",t))}),$(".body-result").on("mouseover mouseout","[sameAs],[data-sameas]",function(t){c!==s.MANYO&&(t.stopPropagation(),I(this,"sameAs",t))}),$(".body-result").on("mouseover mouseout","[target],[data-target]",function(t){c!==s.MANYO&&(t.stopPropagation(),I(this,"target",t))}),$(".body-result").on("mouseover mouseout","[xml\\:id]",function(t){if(c!==s.MANYO){const e=$(this).attr("xml:id");if(e){const n=S($("body"),e,"corresp"),a=$("body").find('[sameAs="#'+e+'"],[data-sameas="#'+e+'"]'),o=S($("body"),e,"target"),i="mouseover"===t.type,s=!1,c=n.add(a).add(o);c.length&&_(i,this,c,e,s,"xmlidref-highlight")}}}),$(".body-result").on("click","[corresp],[data-corresp],[sameAs],[data-sameas],[target],[data-target],[xml\\:id]",function(){const t=$(this).attr("data-graphid");t&&(T[t]=!0)}),$("#graph_result").on("click",".dotgraph .btn-close",function(){const t=$(this).parent().attr("id");d3.select("#"+t).selectAll("svg").remove(),d3.select("#"+t).graphviz().destroy(),$(this).parent().remove(),t in T&&delete T[t]}),$("#graph_result").on("click",".dotgraph .svglink",function(){const t=$(this).parent().find("svg");if(t.length>0){const e=$(t[0]).find("title"),n=e.length>0?$(e[0]).text():$(this).parent().attr("id"),a=(new XMLSerializer).serializeToString(t[0]),o=new Blob([a],{type:"image/svg+xml"}),i=n+".svg",s=URL.createObjectURL(o),c=document.createElement("a");c.href=s,c.download=i,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(s)}}),$("#graph_result").on("click",".dotgraph .pnglink",function(){const t=$(this).parent().find("svg");if(t.length>0){const e=$(t[0]).find("title"),n=e.length>0?$(e[0]).text():$(this).parent().attr("id"),a=(new XMLSerializer).serializeToString(t[0]),o="data:image/svg+xml;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(a))),i=new Image;i.addEventListener("load",function(){const e=document.createElement("canvas");e.width=t[0].width.baseVal.value,e.height=t[0].height.baseVal.value,e.getContext("2d").drawImage(i,0,0);const a=n+".png",o=document.createElement("a");o.href=e.toDataURL("image/png"),o.download=a,document.body.appendChild(o),o.click(),document.body.removeChild(o)}),i.src=o}}),$(".body-result").on("mouseover mouseout","figure",function(e){e.stopPropagation();if("mouseover"===e.type){if($(this).addClass("figure-highlight"),t.enableGraph){const t=function(t){let e=0;function n(t){let n;t.hasAttribute("n")?n=t.getAttribute("n"):(n=(e++).toString(),t.setAttribute("n",n));const a=$(t).children("label");return a.length>0?{nodename:"node"+n.replace(/\./g,"_"),nodelabel:'[label="'+a[0].textContent+'"]'}:null}let a="";return function t(e){let o;if("etree"===e.nodeName.toLowerCase()){const t=n(e);if(t){a+=t.nodename+t.nodelabel+"\n",o=t.nodename;const i=$(e).parent().get(0);if(i&&"etree"===i.nodeName.toLowerCase()){const e=n(i);e&&(a+=e.nodename+" -> "+t.nodename+"\n")}}}if(e.hasChildNodes()){let i=e.childNodes;for(const e of i){const i=e.nodeName.toLowerCase();if("etree"===i)t(e);else if("eleaf"===i){const t=n(e);t&&(a+=t.nodename+t.nodelabel+"\n",a+=o+" -> "+t.nodename+"\n")}}}}(t),a?a="digraph {"+a+"}":""}(this);if(t){const e="xmlidgraph"+E;$(this).attr("data-graphid",e),E++;const n=$("<div>").attr({id:e,role:"alert"}).addClass("dotgraph alert alert-light alert-dismissible fade show mt-2 mb-0");$("#graph_result").prepend(n),d3.select("#"+e).graphviz({zoom:!1}).renderDot(t).on("end",function(){n.append('<button type="button" class="btn-close" aria-label="Close"></button>'),n.append('<button type="button" class="btn svglink" title="グラフの保存（SVG）"><i class="fas fa-download"></i></button>'),n.append('<button type="button" class="btn pnglink" title="グラフの保存（PNG）"><i class="far fa-file-image"></i></button>')})}}}else $(this).removeClass("figure-highlight"),t.enableGraph&&$("#graph_result").find(".dotgraph").each(function(){const t=$(this).attr("id");t in T||(d3.select("#"+t).selectAll("svg").remove(),d3.select("#"+t).graphviz().destroy(),$(this).remove())})}),$(".body-result").on("click","figure",function(){const t=$(this).attr("data-graphid");t&&(T[t]=!0)});let U=null,j=null;function z(e){const n=document.querySelector("#home_tab");if(bootstrap.Tab.getInstance(n).show(),U){let t=!1;$.isPlainObject(U.tileSources)?U.tileSources.url!==e[0].graphicUrl&&(t=!0):t=!0,t&&F()}if(U)R(e);else{let n=void 0;if(e[0].manifest?n=!0:e[0].graphicUrl&&(n=!1),void 0===n)return;const a=$("<div>").addClass("clearfix"),o=b(n?"en"===d?"IIIF Image":"IIIF画像":"en"===d?"Image":"画像").addClass("float-start"),i=$("<a>").attr("href","javascript:void(0);").addClass("float-end btn btn-sm px-0 py-1").text("en"===d?"Close":"閉じる");i.on("click",F),a.append(o).append(i);const s=$("<div>").attr("id","iiif_image").append(a),c=$('<div id="icveframe" class="my-2">');c.css({width:"100%",height:"400px"}),t.openSeadragon.highlight||c.addClass("no-border"),s.append(c),s.insertAfter($("#input1"));const l=n?e[0].canvasInfo+"/info.json":{type:"image",url:e[0].graphicUrl,buildPyramid:!1};(U=OpenSeadragon({id:"icveframe",prefixUrl:"lib/openseadragon-4.1.1/images/",preserveViewport:!0,visibilityRatio:1,minZoomLevel:1,defaultZoomLevel:1,sequenceMode:!1,showHomeControl:!1,showFullPageControl:!1,tileSources:l})).addHandler("open",function(){R(e)})}}function R(t){function e(t,e,n){let a=parseFloat(t.ulx||0),o=parseFloat(t.uly||0),i=parseFloat(t.lrx||0)-a,s=parseFloat(t.lry||0)-o,c=t.points;if(c){let e,a;if(t.manifest?t.canvasSize&&t.canvasSize.width>0&&t.canvasSize.height>0&&t.canvasInfoSize&&t.canvasInfoSize.width>0&&t.canvasInfoSize.height>0&&(e=t.canvasSize.width/t.canvasInfoSize.width,a=t.canvasSize.height/t.canvasInfoSize.height):t.graphicUrl&&t.graphicSize&&t.graphicSize.width>0&&t.graphicSize.height>0&&(e=1,a=1),void 0===e||void 0===a)return;const o=[];c.split(" ").forEach(function(t){const i=t.match(/(-?[0-9]+(?:\.[0-9]+)?),(-?[0-9]+(?:\.[0-9]+)?)/);if(i){const t=parseFloat(i[1])*e,s=parseFloat(i[2])*a;o.push(t+","+s),n&&n.addPoint(t,s)}}),c=o.join(" ")}else c=a+","+o+" ",c+=a+i+","+o+" ",c+=a+i+","+(o+s)+" ",c+=a+","+(o+s),n&&(n.addPoint(a,o),n.addPoint(a+i,o),n.addPoint(a+i,o+s),n.addPoint(a,o+s));c&&e.push(c)}function n(t){return{"@context":"http://www.w3.org/ns/anno.jsonld",id:"#"+URL.createObjectURL(new Blob).slice(-36),type:"Annotation",body:[],target:{selector:{type:"SvgSelector",value:'<svg><polygon points="'+t+'"></polygon></svg>'}}}}let a;t.length&&(a=new ConvexHullGrahamScan);const o=[];for(const n of t)e(n,o,a);if(o.length){j||(j=OpenSeadragon.Annotorious(U,{disableEditor:!0,disableSelect:!0,readOnly:!0}));var i=j;i.clearAnnotations();for(const t of o){const e=n(t);i.addAnnotation(e,!1),1===o.length&&i.fitBounds(e,{immediately:!0,padding:20})}if(o.length>0&&a){const t=a.getHull(),e=[];for(const n of t)e.push(n.x+","+n.y);const o=n(e.join(" "));i.formatters=function(){return"no-border"},i.addAnnotation(o,!1),i.formatters=function(){},i.fitBounds(o,{immediately:!0,padding:20})}}}function F(){j&&(j.destroy(),j=null),U&&(U.destroy(),U=null),$("#iiif_image").remove()}$(".body-result,#bottom_result,#right_col").on("click",".fac-image[data-facs-target-xmlid]",function(){const t=$(this).attr("data-facs-target-xmlid"),n=i;if(n in e&&t in e[n]){const a=e[n][t];(a.manifest||a.graphicUrl)&&z([a])}}),$(".body-result").on("click",".facs-image[data-facs-target-xmlids]",function(){const n=$(this).attr("data-facs-target-xmlids").split(" "),a=i;if(a in e&&t.useOpenSeadragon){const t=[],o=[];for(const i of n)if(i in e[a]){const n=e[a][i];n.manifest?t.push(n):n.graphicUrl&&o.push(n)}let i;t.length?i=t:o.length&&(i=o),i&&z(i)}});let H=null;$(".body-result").on("click",".place-location-geo",function(){const t=[parseFloat($(this).attr("data-lat")),parseFloat($(this).attr("data-lng"))],e=document.querySelector("#home_tab");if(bootstrap.Tab.getInstance(e).show(),H)H.eachLayer(function(t){void 0!==t._icon&&H.removeLayer(t)}),L.marker(t).addTo(H),H.panTo(t);else{const e=$("<div>").addClass("clearfix"),n=b("en"===d?"Map":"地図").addClass("float-start"),a=$("<a>").attr("href","javascript:void(0);").addClass("float-end btn btn-sm px-0 py-1").text("en"===d?"Close":"閉じる");a.on("click",function(){H&&(H.remove(),H=null),o.remove()}),e.append(n).append(a);const o=$('<div class="my-2">').attr("id","map_section").append(e),i=$('<div id="map" class="my-2">');i.css({width:"100%",height:"400px"}),o.append(i),o.insertAfter($("#input1")),H=L.map("map",{center:t,zoom:5}),L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(H),L.marker(t).addTo(H)}}),$("#body_result,#bottom_result").on("wheel",function(t){if(r===l.HORIZONTAL)return;const e=t.originalEvent;Math.abs(e.deltaY)<Math.abs(e.deltaX)||(e.preventDefault(),this.scrollLeft-=e.deltaY)})};