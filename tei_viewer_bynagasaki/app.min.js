/*
 * A TEI Viewer for East Asian Pre-Modern Texts
 *
 * Copyright 2024 International Institute for Digital Humanities
 * Copyright 2024 FLX Style
 * Copyright 2025 Keio University
 * Released under the GPL
 *
 * Originally written by Kiyonori NAGASAKI (International Institute for Digital Humanities)
 * Further developed by Jun HOMMA (FLX Style)
 */
/**
 * getElementXPath() and getElementTreeXPath() are based on firebug
 * https://github.com/firebug/firebug/blob/master/extension/content/firebug/lib/xpath.js
 * 
 * firebug
 * BSD License
 * Copyright (c) 2009, Mozilla Foundation
 * https://github.com/firebug/firebug/blob/master/extension/license.txt
 */
"use strict";function copyAttributes(t,e){const n=t.attributes;for(const t of n){const n=t.name;0===n.indexOf("xml:")?(e.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,t.value),e.setAttribute("data-"+n.replace(":",""),t.value)):n.indexOf(":")>-1?(e.setAttributeNS(null,n,t.value),e.setAttribute("data-"+n.replace(":",""),t.value)):0===n.indexOf("data-")?e.setAttribute(n,t.value):"id"===n?e.setAttribute("id",t.value):e.setAttribute("data-"+n,t.value)}t.hasAttribute("style")&&e.setAttribute("style",t.getAttribute("style"))}function preprocessSelfClosingTags(t){const e=[{xml:"anchor"},{xml:"milestone"},{xml:"lb",html:"br"},{xml:"pb"}];for(const n of e)t.querySelectorAll(n.xml).forEach(e=>{const a=n.html||"param",o=t.createElement(a);o.setAttribute("class",n.xml),copyAttributes(e,o),e.parentNode.replaceChild(o,e)})}function preprocessXmlId(t,e){const n=e||"";t.querySelectorAll("[*|id]").forEach(t=>{if(!t.hasAttribute("id")){const e=n+t.getAttribute("xml:id");t.setAttribute("id",e)}})}function replaceWithElement(t,e){const n=t.nodeName.toLowerCase(),a=document.createElement(e);if(a.setAttribute("class",n),a.setAttribute("data-original-tag-name",t.nodeName),copyAttributes(t,a),t.hasChildNodes()){const e=t.childNodes;for(const t of e)a.appendChild(t.cloneNode(!0))}return t.parentNode.replaceChild(a,t),a}function normalizeSpaceXML(t){const e=(new DOMParser).parseFromString('<?xml version="1.0" encoding="UTF-8"?><xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:tei="http://www.tei-c.org/ns/1.0"><xsl:template match="*[not(node())]"><xsl:copy><xsl:apply-templates select="@*" /><xsl:comment></xsl:comment></xsl:copy></xsl:template><xsl:template match="node()|@*"><xsl:copy><xsl:apply-templates select="@*" /><xsl:apply-templates /></xsl:copy></xsl:template><xsl:template match="text()"><xsl:value-of select="normalize-space(.)" /></xsl:template></xsl:stylesheet>',"application/xml"),n=new XSLTProcessor;return n.importStylesheet(e),n.transformToDocument(t)}function showAppPlace(t,e,n,a,o){function i(e,n,a,o,i){!function e(n,a,o,i,s,c){const l=n.childNodes;for(const n of l){const l=n.nodeType;let r=!1,d=!1,p=!1;if(l===Node.ELEMENT_NODE&&"param"===n.nodeName&&(r=!0,n.hasAttribute("xml:id"))){const t=n.getAttribute("xml:id");t===i&&(d=!0),t===s&&(p=!0)}if(r||l===Node.TEXT_NODE){let e=!1;if(r?(d&&(c.flag=!0),p&&(c.flag=!1),(d||p)&&(e=!0)):l===Node.TEXT_NODE&&c.flag&&n.textContent.trim().length>0&&(e=!0),e){const e=t.createElement("span");e.className="ct",e.setAttribute("data-n",String(o)),e.appendChild(n.cloneNode(!0)),a.appendChild(e)}else a.appendChild(n.cloneNode(!0))}else if(l===Node.ELEMENT_NODE||l===Node.DOCUMENT_NODE||l===Node.DOCUMENT_FRAGMENT_NODE){const t=n.cloneNode(!1);a.appendChild(t),e(n,t,o,i,s,c)}}}(e,n,a,o,i,{flag:!1})}n||(n=1);let s=n-1;const c=[],l={};for(const n of Object.keys(e))for(var r=0;r<e[n].length;r++){const h=n,f=e[n][r],u=t.getElementById(o+h),m=t.getElementById(o+f);if(s++,h in l||(l[h]=[]),l[h].push(s),u){const o=a?s:getCjkDecimal(s),g=m?"":"（範囲の終わり "+f+" がありません）";if(m||c.push({type:"appToNotFound",anchorNo:s,appFrom:h,appTo:f}),r>0)for(var d=r-1;d>=0;d--)if(e[n][d]===f){c.push({type:"duplicate",anchorNo:s,appFrom:h,appTo:f,anchorNoRef:l[h][d]});break}const b=t.createElement("span");if(b.className="ft artifact",b.setAttribute("data-n",String(s)),b.textContent=o+g,u.parentNode.insertBefore(b,u),m){const e=new Range;if(e.setStartBefore(u),e.setEndAfter(m),e.startContainer===e.endContainer){const n=t.createElement("span");n.className="ct",n.setAttribute("data-n",String(s));try{e.surroundContents(n)}catch(t){console.log(t)}}else{const t=e.commonAncestorContainer;var p=t.cloneNode(!1);i(t,p,s,h,f),t.parentNode.replaceChild(p,t)}}else console.log(g)}}return c}function preprocessInlineNote(t,e,n,a,o){n||(n=[]);const i=(o=o||"")+"note_start_",s=o+"note_end_";let c=1;!function t(e){0!==e.childNodes.length&&e.childNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE&&"param"===e.nodeName&&!e.hasAttribute("xml:id")&&"noteEnd"===e.getAttribute("data-type")){const t=s+String(c).padStart(8,"0");e.setAttributeNS("http://www.w3.org/XML/1998/namespace","xml:id",t),e.hasAttribute("id")||e.setAttribute("id",o+t),c++}t(e)})}(t);let l=1;!function t(e,o){0!==e.childNodes.length&&e.childNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){if("span"===e.nodeName&&"note"===e.getAttribute("class")){let t=!0;a&&a.length>0?t=!1:n.length>0&&(t=!0);let s,c=!1,r=!1;a&&a.length>0?e.hasAttribute("data-type")&&(s=e.getAttribute("data-type"),a.indexOf(s)>-1&&(c=!0)):n.length>0&&e.hasAttribute("data-type")&&(s=e.getAttribute("data-type"),n.indexOf(s)>-1&&(r=!0)),(!t&&c||t&&!r)&&(e.setAttribute("data-n",l),l++),e.hasAttribute("data-target")?e.setAttribute("data-target",e.getAttribute("data-target").replace(/^#/,"")):e.hasAttribute("xml:id")&&e.setAttribute("data-target",i+e.getAttribute("xml:id")),e.hasAttribute("data-targetend")?e.setAttribute("data-targetend",e.getAttribute("data-targetend").replace(/^#/,"")):(!t&&c||t&&!r)&&o.push(e)}if(o.length>0&&"param"===e.nodeName&&"noteEnd"===e.getAttribute("data-type")&&e.hasAttribute("xml:id")){const t=e.getAttribute("xml:id");o.pop().setAttribute("data-targetend",t)}}t(e,o)})}(t,[]),function t(e,n){0!==e.childNodes.length&&e.childNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE&&"span"===e.nodeName&&"note"===e.getAttribute("class")){var a=e.getAttribute("data-target"),o=e.getAttribute("data-targetend");a&&o&&(a in n||(n[a]=[]),n[a].push(o))}t(e,n)})}(t,e),t.querySelectorAll("span.note").forEach(e=>{const n=t.createElement("param");if(n.setAttribute("class","anchor"),e.hasAttribute("xml:id")){const t=i+e.getAttribute("xml:id");n.setAttributeNS("http://www.w3.org/XML/1998/namespace","xml:id",t),n.setAttribute("id",o+t)}e.after(n)})}function postprocessInlineNote(t){const e=t.querySelectorAll("span.ct");for(var n=0;n<e.length;n++){const t=e[n],a=n>0?e[n-1]:void 0,o=n<e.length-1?e[n+1]:void 0,i=t.getAttribute("data-n"),s=a?a.getAttribute("data-n"):void 0,c=o?o.getAttribute("data-n"):void 0;i===s&&t.setAttribute("data-n-prev-same","true"),i===c&&t.setAttribute("data-n-next-same","true")}}function getCjkDecimal(t){const e=["〇","一","二","三","四","五","六","七","八","九"],n=String(t);let a="";for(var o=0;o<n.length;o++){a+=e[parseInt(n[o].codePointAt(0))-48]}return a}function checkVariantEncodingMethod(t){let e=void 0;return t.querySelectorAll("TEI > teiHeader > encodingDesc > variantEncoding").forEach(t=>{if(t.hasAttribute("method")){const n=t.getAttribute("method");e=["location-referenced","double-end-point","parallel-segmentation"].indexOf(n)>-1?n:null}}),e}function isDiplomaticAnnotatedDocument(t){let e=!1;return t.querySelectorAll('TEI > teiHeader > encodingDesc seg[type="annotation"]').forEach(t=>{"diplomatic"===t.textContent&&(e=!0)}),e}function getElementXPath(t){return t&&t.id?'//*[@id="'+t.id+'"]':getElementTreeXPath(t)}function getElementTreeXPath(t){for(var e=[];t&&t.nodeType==Node.ELEMENT_NODE;t=t.parentNode){for(var n=0,a=!1,o=t.previousSibling;o;o=o.previousSibling)o.nodeType!=Node.DOCUMENT_TYPE_NODE&&o.nodeName==t.nodeName&&++n;for(o=t.nextSibling;o&&!a;o=o.nextSibling)o.nodeName==t.nodeName&&(a=!0);var i=(t.prefix?t.prefix+":":"")+t.localName,s=n||a?"["+(n+1)+"]":"";e.splice(0,0,i+s)}return e.length?"/"+e.join("/"):null}const TEIViewer=function(t){console.log("A TEI Viewer for East Asian Pre-Modern Texts 0.1.0+20250516");const e={},n={},a={},o={},i="facsimile_surfaceGrp_surface_zone",s={DEFAULT:0,MANYO:1,WAKASHUU:4,UTAAWASE:5};let c=s.DEFAULT;const l={DEFAULT:0,VERTICAL:0,HORIZONTAL:1};let r=l.DEFAULT,d="ja";{const t=new URLSearchParams(window.location.search);t.has("lang")&&("en"!==t.get("lang")&&"ja"!==t.get("lang")||(d=t.get("lang")))}$.isPlainObject(t)||(t={}),function(){$.isArray(t.xmlidPickup)||(t.xmlidPickup=[]),t.xmlidPickupSelector=[],t.xmlidPickupDict={};for(let e of t.xmlidPickup)$.isPlainObject(e)&&e.selector&&-1===t.xmlidPickupSelector.indexOf(e.selector)&&(t.xmlidPickupSelector.push(e.selector),t.xmlidPickupDict[e.selector]=e.label||e.selector)}(),function(){if(t.xmlidListPickupSelector=[],t.xmlidListPickupDict={},t.xmlidListPickupOption={},t.xmlidListPickup)for(let e of t.xmlidListPickup)$.isPlainObject(e)&&e.selector&&-1===t.xmlidListPickupSelector.indexOf(e.selector)&&(t.xmlidListPickupSelector.push(e.selector),t.xmlidListPickupDict[e.selector]=e.label||e.selector,t.xmlidListPickupOption[e.selector]=e)}(),$.isPlainObject(t.typeToGraphLabelMapping)||(t.typeToGraphLabelMapping={}),t.enableGraph=!!t.enableGraph,t.useOpenSeadragon=!0,$.isPlainObject(t.openSeadragon)||(t.openSeadragon={}),t.openSeadragon.highlight=!(!t.openSeadragon.highlight&&"highlight"in t.openSeadragon),t.showLegends=!(!t.showLegends&&"showLegends"in t),t.showVersions=!(!t.showVersions&&"showVersions"in t),t.showChoice=!(!t.showChoice&&"showChoice"in t),t.showTextStructures=!(!t.showTextStructures&&"showTextStructures"in t),t.enableBodyResize=!(!t.enableBodyResize&&"enableBodyResize"in t),t.enableSearch=!!t.enableSearch,t.enableFileDescTab=!(!t.enableFileDescTab&&"enableFileDescTab"in t),t.fixedAppType=!!("appType"in t),"appType"in t&&(c=t.appType),function(){const t=$("<div>").addClass("offcanvas offcanvas-start").attr({id:"offcanvas_for_images","data-bs-backdrop":!1,"data-bs-scroll":!0,tabindex:-1}),e=$("<div>").addClass("offcanvas-header"),n=$("<h5>").addClass("offcanvas-title").attr({id:"offcanvas_for_images_title"}),a=$("<button>").addClass("btn-close").attr({type:"button","data-bs-dismiss":"offcanvas","aria-label":"Close"}),o=$("<div>").addClass("offcanvas-body").attr({id:"offcanvas_for_images_body"});e.append(n).append(a),t.append(e).append(o),$("body").append(t),t.resizable()}();let p=!1;{const t=new URLSearchParams(window.location.search);if(t.has("debug")&&(p=!!t.get("debug")),t.has("file"))try{const e=t.get("file"),n=new URL(e,window.location.href);$.ajax(n.href,{type:"get"}).done(function(n){$('#input1 input[type="file"]').hide(),$("#input1").append(e),$("#row2").remove();const a=n instanceof XMLDocument?n:$.parseXML(n),o=t.has("xmlid")?t.get("xmlid"):void 0;o&&history.replaceState&&(t.delete("xmlid"),history.replaceState(null,"",location.pathname+"?"+t.toString())),h(a,void 0,o)})}catch(t){console.log(t)}if(t.has("file1")&&t.has("file2"))try{const e=t.get("file1"),n=t.get("file2"),a=new URL(e,window.location.href),o=new URL(n,window.location.href);$.when($.ajax(a.href,{type:"get"}),$.ajax(o.href,{type:"get"})).done(function(t,e){$('#input1 input[type="file"]').hide(),$("#row2").show(),h(t[0]instanceof XMLDocument?t[0]:$.parseXML(t[0]),void 0),h(e[0]instanceof XMLDocument?e[0]:$.parseXML(e[0]),2)})}catch(t){console.log(t)}}function h(o,h,f){const g=(new Spin.Spinner).spin(document.body);(async function(o,h,f){const g=h||1,x=g-1,A=1===g,k=$("#body_result"+(h||""));k.html("");const w=$("#bottom_result"+(h||""));w.html(""),A&&($("#graph_result").html(""),$("#errors").html(""),$("#legends").html(""),$("#versions").html(""),$("#choice").html(""),$("#additionalUIs").empty());x in e||(e[x]={});x in n||(n[x]={});x in a||(a[x]={});const E=e[x],T=n[x],L=a[x];let O,M,P=!0,D=0;const I=normalizeSpaceXML(o);preprocessSelfClosingTags(I);const j=function(t){let e,n;do{e=Math.random().toString(16).substr(2,8),n=!(null===document.querySelector('[id^="'+e+'"]')&&null===t.querySelector('[*|id^="'+e+'"]'))}while(n);return e}(I)+"_";preprocessXmlId(I,j);const U=checkVariantEncodingMethod(I);!t.fixedAppType&&isDiplomaticAnnotatedDocument(I)&&(c=s.MANYO);$(I).find("TEI > text > body").each(function(){const t=$(this).attr("style");t&&/writing-mode:\s*horizontal-tb/i.test(t)&&(r=l.HORIZONTAL)}),r===l.HORIZONTAL&&($("#text_body").css("writing-mode","horizontal-tb").addClass("writing-mode-horizontal-tb"),$("#body_result").css({overflow:"auto",height:"100%"}));var R,z;switch($(I).find("TEI > teiHeader").each(function(e,n){const a=$(n);let o=!1;const i=$("<div>").addClass("teiHeader");a.find("fileDesc").each(function(){const e=$(this),n=$("<div>").addClass("fileDesc");i.append(n),e.find("titleStmt").each(function(){const e=$(this),a=$("<div>").addClass("titleStmt");e.find("title").each(function(){const e=$(this),n=$("<div>").addClass("title").html(e.html());a.append(n);const o=e.text();t.fixedAppType||(0===o.indexOf("萬葉集")?c=s.MANYO:o.includes("和歌集")?c=s.WAKASHUU:o.endsWith("歌合")&&(c=s.UTAAWASE));let i=t.appName||"TEI古典籍ビューワ";$("title").text([o,i].join(" | "))}),e.find("author,editor,funder,meeting,principal,respStmt,sponsor").each(function(){const t=$("<div>").addClass(this.tagName).html($(this).html());a.append(t)}),n.append(a),o=!0}),t.enableFileDescTab&&(R=$("<div>").addClass("publicationStmt mb-3"),e.find("publicationStmt").each(function(){const t=$(this);let e;R.append(b("電子テキストの出版情報"));const n=this.firstChild;if(n){const t=n.tagName.toLowerCase();e="publisher"===t||"distributor"===t||"authority"===t}const a=$("<div>");e?t.find("publisher,distributor,authority,availability").each(function(){const t=$("<div>").addClass(this.tagName).html($(this).html());a.append(t)}):a.append(t.html()),R.append(a)}),z=$("<div>").addClass("sourceDesc"),e.find("sourceDesc").each(function(){const t=$(this);z.append(b("電子テキストのソースの情報")),t.find("bibl").each(function(){const t=$(this);if(t.text().length){const e=$("<div>").addClass("bibl"),n=y("書誌情報");e.append(n).append(t.html()),z.append(e)}}),t.find("msDesc").each(function(){const t=$(this),e=$("<div>").addClass("msDesc"),n={msIdentifier:{label:"手稿の識別情報",blockTags:["idno","altIdentifier","collection","institution","msName","repository","bloc","country","district","geogName","objectName","placeName","region","settlement"]},msContents:{label:"手稿の内容",blockTags:["p","textLang","ab","msItem","msItemStruct","summary","titlePage"]},physDesc:{label:"物理的側面の記述",blockTags:["p","ab","accMat","additions","bindingDesc","decoDesc","handDesc","musicNotation","objectDesc","scriptDesc","sealDesc","typeDesc"]},history:{label:"由来",blockTags:["p","ab","acquisition","origin","provenance","summary"]}};if(t.find("msIdentifier,msContents,physDesc,history").each(function(){const t=$(this),a=n[this.tagName]||{},o=(i=a.label||this.tagName,$("<div>").addClass("heading3").text(i));var i;const s=$("<div>").addClass(this.tagName).append(o);let c;const l=a.blockTags||[];if(l.length){const e="div";for(const n of l)if(n!==e)for(c=t.find(n);c.length>0;)c.each(function(){replaceWithElement(this,e)}),c=t.find(n)}t.text().length&&(s.append(t.html()),e.append(s))}),e.text().length){const t=y("手稿に関する記述");e.prepend(t),z.append(e)}})}))}),o&&k.append(i)}),c){case s.MANYO:$("#text_body").addClass("manyo").css("max-height",""),$("#text_bottom").addClass("manyo"),t.enableGraph=!1,t.enableBodyResize=!1;break;case s.WAKASHUU:$("#text_body").addClass("wakashuu"),t.openSeadragon.highlight=!0;break;case s.UTAAWASE:$("#text_body").addClass("utaawase"),t.openSeadragon.highlight=!0}switch(c){case s.MANYO:break;case s.WAKASHUU:case s.UTAAWASE:}let H={};switch(c){case s.MANYO:case s.WAKASHUU:case s.UTAAWASE:break;default:t.enableSearch=!1}const F=/^(合点|注|異文|異訓|訓)$/;let X=1;function B(t){return j+t}function Y(t){return j+"anchor_xmlid_"+t}function W(t){if(P)return;const e=t||$("#body_result"),n={},a=$("#text_body .text:first").height();e.find(".note").each(function(t,e){const a=e.getAttribute("data-type");if(a&&a.match(F)){const t=e.getAttribute("data-target"),a=$("#"+Y(t));let o,i;const s=a.position();s?(o=s.top,i=s.left):(o=0,i=void 0);const c=a.width();n[t]={top:o,left:i,width:c}}}),e.find(".note").each(function(t,e){const o=$(e),i=o.attr("data-type");if(i&&i.match(F)){const t=o.attr("data-target");if(t in n){const e=n[t];let i=e.top,s=e.left,c=e.width,l=e.end||{};const r={},d=o.attr("data-place");let p;if(void 0!==s&&(s="right"===d||"margin-right"===d?"calc("+(s+=c)+"px + 0.1em)":"left"===d||"margin-left"===d?"calc("+(s-=c)+"px - 0.1em)":"calc("+(s+=c)+"px + 0.1em)",r.left=s),"margin-bottom"===d)p=0;else if("above"===d)p=a-i+"px";else if("margin-head"===d){i=0;const t=o.attr("data-subtype");"貼紙"!==t&&(r.height="5rem")}else"below"===d&&l&&(i=l.top+"px");void 0!==p?r.bottom=p:r.top=i,Object.keys(r).length&&o.css(r),o.draggable()}}})}function q(t){const e="xml:idに重複があります。"+t;console.error(e),$("#errors").append($("<div>").addClass("color-red").text(e))}if(await async function(){await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>requestAnimationFrame(t))}(),$(I).find("TEI > text").each(function(e,n){let a="";const o={},l=X,r=$(n),h=$("<div>").addClass("text");function f(t,e,n){const i=$(t);i.attr("data-app-n",X);const s=[];i.children("lem").each(function(){const t=$(this),e=t.html(),n=t.attr("wit")||"本文",a=n.split(" "),o=[];a.forEach(function(t){o.push('<span class="wtnm">'+t.replace(/^#/,"")+"</span>")});const i=t.attr("facs"),c=$("<div>").addClass("lem"),l=$("<span>").addClass("footnote-head").html("［"+o.join(" ")+"］"),r=i?$("<span>").addClass("footnote-facs").attr({facs:i}):"",d=$("<span>").addClass("footnote-content").html(e);c.attr({"data-wit":n,"data-n":String(X)}).append(l).append(r).append(d),s.push(c.prop("outerHTML")),t.attr("data-app-n",X),t.attr("data-facs-backup",i),t.removeAttr("facs")}),i.children("rdg").each(function(){const t=$(this),n=t.html(),a=t.attr("wit");if(a){const o=a.split(" "),i=[];o.forEach(function(t){i.push('<span class="wtnm">'+t.replace(/^#/,"")+"</span>")});const c=t.attr("facs"),l=$("<div>").addClass("rdg"),r=$("<span>").addClass("footnote-head").html("［"+i.join(" ")+"］"),d=c?$("<span>").addClass("footnote-facs").attr({facs:c}):"",p=$("<span>").addClass("footnote-content").html(n);if(l.attr({"data-wit":a,"data-n":String(X)}).append(r).append(d).append(p),s.push(l.prop("outerHTML")),"double-end-point"!==e){const e=$("<span>");a&&e.attr("data-wit",a);const o=$("<span>").addClass("rdg").addClass("parallel-segmentation-rdg").html(n);a&&(o.attr("wit",a),o.attr("data-app-n",X)),e.append(o),t.replaceWith(e)}}else console.error("<rdg> without @wit found!"),console.error(i)}),i.children("note").each(function(){s.push('<div class="note">'+$(this).html()+"</div>")});const c=getCjkDecimal(X);let l,r;if("double-end-point"===e)l=(i.attr("from")||"").replace(/^#/,""),r=(i.attr("to")||"").replace(/^#/,"");else{l=n+"_"+X+"s",r=n+"_"+X+"e";const t=$("<param>").addClass("anchor").attr({id:B(l),"xml:id":l}),e=$("<param>").addClass("anchor").attr({id:B(r),"xml:id":r});i.prepend(t).append(e)}a+='<div class="app" data-n="'+String(X)+'"><div class="appnum" title="クリックでハイライト切り替え">'+c+'<span class="cthltgl" title="ハイライト切り替え"><span class="ui-icon ui-icon-radio-on"></span></span></div>'+s.join("")+"</div>",l in o||(o[l]=[]),o[l].push(r),X++}if(r.find("[rend]").each(function(){const t=$(this),e=t.attr("rend");e&&e.split(" ").forEach(function(e){"italic"===e&&t.addClass("italic")})}),r.find("listApp").each(function(){$(this).find("app").each(function(){f(this,"double-end-point")})}),(0===Object.keys(o).length||"double-end-point"!==U)&&r.find("body").each(function(){const t=j;$(this).find("app").each(function(){f(this,"parallel-segmentation",t)})}),0===Object.keys(o).length);else{let t;void 0===U?t="&lt;encondingDesc&gt;以下の&lt;variantEncoding&gt;の@method属性で、methodを記述しなければ&lt;app&gt;は表示できません。":null===U?t='&lt;encondingDesc&gt;以下の&lt;variantEncoding&gt;の@method属性値が誤っています。本ビューワでは"double-end-point", "parallel-segmentation"のいずれかを指定してください。':"location-referenced"===U&&(t='&lt;encondingDesc&gt;以下の&lt;variantEncoding&gt;の@method属性値について、本ビューワでは"location-referenced"の表示には未対応です。'),t&&(a=t)}""!==a&&(M=!0,w.append(a)),t.enableGraph&&A&&$("#graph_result").prepend('<div class="alert alert-light alert-dismissible fade show mt-2 mb-0" role="alert">本文のマウスオーバーでグラフ表示、そのままクリックでグラフを固定します。<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');const m=t.xmlidListPickupSelector;if(t.enableXmlidListPickup)for(const t of m)r.find(t).each(function(){if(this.hasAttribute("xml:id")){const e=this.getAttribute("xml:id");t in L||(L[t]=[]),L[t].push(e)}});const g=t.xmlidPickupSelector;if(g.length){N(r,"corresp",x),N(r,"sameAs",x),N(r,"target",x);for(const t of g)r.find(t).each(function(){if(this.hasAttribute("xml:id")){const e=this.getAttribute("xml:id");if(t in E||(E[t]={}),e in E[t])q(e);else{const n=T.corresp[e]||[],a=T.sameAs[e]||[],o=T.target[e]||[];E[t][e]={tag:this.nodeName.toLowerCase(),type:this.hasAttribute("type")?this.getAttribute("type"):void 0,corresps:n,sameAses:a,targets:o,text:this.textContent,node:this}}}})}const y="teiHeader_fileDesc_sourceDesc_listWit_witness";let v=!1,C=!1;$(I).find("TEI > teiHeader > fileDesc > sourceDesc listWit").each(function(){const e=y;t.xmlidPickupDict[e]="対校資料",$(this).find("witness").each(function(){if(this.hasAttribute("xml:id")){const t=this.getAttribute("xml:id");e in E||(E[e]={}),t in E[e]?q(t):(E[e][t]={tag:this.nodeName.toLowerCase(),type:this.hasAttribute("type")?this.getAttribute("type"):void 0,wits:[],text:this.textContent,node:this},v=!0)}})}),function(){let e=1;const n=y;if(r.find("listApp").each(function(){$(this).find("app").each(function(){const t=$(this);t.find("rdg").each(function(){const a=this,o=$(this).attr("wit");o?o.split(" ").forEach(function(t){const o=t.replace(/^#/,"");o in E[n]&&E[n][o].wits.push({n:e,elem:a})}):(console.error("<rdg> without @wit found!"),console.error(t))}),t.find("lem").each(function(){C=!0;const t=this;($(this).attr("wit")||"本文").split(" ").forEach(function(a){const o=a.replace(/^#/,"");o in E[n]&&E[n][o].wits.push({n:e,elem:t})})}),e++})}),r.find("body").each(function(){$(this).find("app").each(function(){const t=$(this),a=Math.random().toString(16).substr(2,9);t.attr("data-temp-app",a),t.find("rdg,.rdg").each(function(){const o=$(this),i=this,s=o.closest("app").attr("data-temp-app");if(a===s){const a=o.attr("wit");a?a.split(" ").forEach(function(t){const a=t.replace(/^#/,"");a in E[n]&&E[n][a].wits.push({n:e,elem:i})}):(console.error("<rdg> without @wit found!"),console.error(t))}}),t.find("lem,.lem").each(function(){C=!0;const t=$(this),o=this,i=t.closest("app").attr("data-temp-app");a===i&&(t.attr("wit")||"本文").split(" ").forEach(function(t){const a=t.replace(/^#/,"");a in E[n]&&E[n][a].wits.push({n:e,elem:o})})}),t.removeAttr("data-temp-app"),e++})}),v&&A){const e=$("#versions");if(e.append(b("テキストの再構成")),Object.keys(E).length>0){const n=E[y];let a=0;{const t="本文",n=$("<div>").addClass("form-check"),o=$("<input>").addClass("form-check-input").attr({type:"radio",name:"versionRadios",id:"versionRadios"+a,value:""}).prop("checked",!0),i=$("<label>").addClass("form-check-label").attr({for:"versionRadios"+a}).text(t);n.append(o).append(i),e.append(n),C||(o.prop("disabled",!0),n.hide())}for(const t in n){a++;const n=u(t,x,{witnessSelectorTempName:y}),o=$("<div>").addClass("form-check"),i=$("<input>").addClass("form-check-input").attr({type:"radio",name:"versionRadios",id:"versionRadios"+a,value:t}),s=$("<label>").addClass("form-check-label").attr({for:"versionRadios"+a}).text(n);o.append(i).append(s),e.append(o)}t.showVersions||e.hide()}}}();const _="facsimile_facs_text",D="facsimile_facs_bottom";function R(t){let e,n;{const n=($(t).attr("width")||"").match(/([-+]?\d+(:?\.\d+)?)px/);n&&(e=parseFloat(n[1]))}{const e=($(t).attr("height")||"").match(/([-+]?\d+(:?\.\d+)?)px/);e&&(n=parseFloat(e[1]))}return e>0&&n>0?{width:e,height:n}:void 0}function z(t,e,n){if($.isPlainObject(n)&&t.hasAttribute("xml:id")){const a=$(t).attr("xml:id");if(e in E||(E[e]={}),!(a in E[e])){const o=[];{const t=T[_];if(t&&a in t)for(const e of t[a]){const t=S();o.push({id:t,elem:e.elem});const n=$(e.elem),i=n.attr("id"),l=$("<button>").attr("type","button").addClass("btn btn-sm btn-light artifact fac-image").html('<i class="far fa-image"></i>').attr({id:t,"data-facs-target-xmlid":a,"data-facs-target-id":i,title:a});n.hasClass("pb")&&(l.attr({"data-facs-target-class":"pb"}),c!==s.MANYO&&l.append("（"+a+"）")),n.prepend(l)}}{const t=T[D];if(t&&a in t)for(const e of t[a]){const t=$("<button>").attr("type","button").addClass("btn btn-sm btn-light artifact fac-image").html('<i class="far fa-image"></i>').attr({"data-facs-target-xmlid":a});$(e.elem).prepend(t)}}return E[e][a]={tag:t.nodeName.toLowerCase(),type:t.hasAttribute("type")?t.getAttribute("type"):void 0,facses:o,lrx:$(t).attr("lrx"),lry:$(t).attr("lry"),ulx:$(t).attr("ulx"),uly:$(t).attr("uly"),points:$(t).attr("points"),text:"",node:t,xmlid:a},Object.assign(E[e][a],n),a}{let t=!0;const o=E[e][a];o.manifest&&!n.manifest&&(t=!1),t&&q(a)}}}$(I).find("TEI > facsimile").each(function(){const e=i;t.xmlidPickupDict[e]="en"===d?"Images":"IIIF画像";const n=$(this).attr("sameAs");if(n){const t=n.split(" ")[0];N(r,"facs",x,{key:_}),N(w,"facs",x,{key:D}),$(this).find("surface").each(function(){const n=$(this),a=n.attr("sameAs"),o={width:parseInt(n.attr("lrx")||0,10),height:parseInt(n.attr("lry")||0,10)};let i,s;n.find("graphic").each(function(){const t=$(this).attr("sameAs");t&&(i=t);const e=R(this);e&&(s=e)});const c={manifest:t,canvas:a,canvasInfo:i,canvasSize:o,canvasInfoSize:s},l=[];n.find("zone").each(function(){const t=z(this,e,c);t&&l.push(t)}),c.childZoneXmlIds=l,z(this,e,c)})}}),$(I).find("TEI > facsimile > surface").each(function(){const e=$(this),n=i;let a,o;if(t.xmlidPickupDict[n]="en"===d?"Images":"画像",N(r,"facs",x,{key:_}),N(w,"facs",x,{key:D}),e.find("graphic").each(function(){if(void 0===a){const t=$(this).attr("url"),e=R(this);e&&(a=t,o=e)}}),a){const t={graphicUrl:a,graphicSize:o};e.find("zone").each(function(){z(this,n,t)}),z(this,n,t)}}),t.useOpenSeadragon&&r.find("[facs],[data-facs]").each(function(){const t=$(this),e=t.attr("facs")||t.attr("data-facs");if(e){const n=e.split(" ");if(n.length>1){let e=[];n.forEach(function(t){e.push(t.replace(/^#/,""))});const a=$("<button>").attr("type","button").addClass("btn btn-sm btn-light artifact facs-image").html('<i class="fas fa-images"></i>');a.attr("data-facs-target-xmlids",e.join(" ")),t.prepend(a)}}});const H=[],G=c!==s.MANYO?"front,body,back":"body";if(r.find(G).each(function(t,e){const n=e.tagName;H.includes(n)||H.push(n);const i=$(e);(function(){const t=["title","l","seg","note","persName","s"];let e;for(const n of t)if("span"!==n)for(e=i.find(n);e.length>0;)e.each(function(){replaceWithElement(this,"span")}),e=i.find(n)})(),function(){const t=["lg","ab"];let e;for(const n of t)if("div"!==n)for(e=i.find(n);e.length>0;)e.each(function(){replaceWithElement(this,"div")}),e=i.find(n)}(),i.find("metamark").each(function(){const t=$(this),e=t.html(),n=this.hasAttribute("function")&&"kaeri"===this.getAttribute("function");if(n&&(O=!0),n&&2===e.length){const n=e[0],a=e[1],o=$("<span>").addClass("metamark").attr("data-function","kaeri").text(n),i=$("<span>").addClass("metamark").attr("data-function","kaeri").text(a);let s;"㆑"===a&&("㆒"===n?o.addClass("oneMark"):"㆖"===n?o.addClass("topMark"):"㆙"===n?o.addClass("firstMark"):"㆝"===n&&o.addClass("heavenMark"),o.addClass("nextIsReverseMark"),i.addClass("reverseMark")),"㆐"===n?s=o:"㆐"===a&&(s=i),s&&s.addClass("tateten").removeAttr("data-function");const c=$("<span>").append(o).append(i);t.replaceWith(c.html())}else{const n=$("<span>").addClass("metamark");n.html(e),copyAttributes(this,n[0]),t.replaceWith(n)}}),i.find(".metamark").each(function(){const t=this.nextSibling;t&&"#text"===t.nodeName&&t.nodeValue&&/^[、。]/.test(t.nodeValue)&&$(this).addClass("nextIsPunctuationMark")}),i.find('span[data-type="wari"].note').each(function(){0===$(this).find("br").length&&$(this).append("<br/>").append($("<span>").addClass("wariSingleLineFiller"))}),c===s.MANYO&&(i.find('.milestone[data-unit="wbr"]').each(function(){$(this).after("<br/>")}),i.find('span[data-type="割書"].note').each(function(){0===$(this).find("br").length&&$(this).append("<br/>").append($("<span>").addClass("wariSingleLineFiller"))})),"body"!==n&&i.find("listPlace").each(function(){$(this).find("place").each(function(){const t=$(this);t.find("location geo").each(function(){const e=$(this).text();if(e){const n=e.match(/(-?[0-9]+(?:\.[0-9]+)?) +(-?[0-9]+(?:\.[0-9]+)?)/);if(n){const e=parseFloat(n[1]),a=parseFloat(n[2]),o=$("<button>").attr("type","button").addClass("btn btn-sm btn-light artifact place-location-geo").html('<i class="fas fa-map-marker-alt"></i>').attr({"data-lat":e,"data-lng":a});t.append(o)}}})})});let r='<div class="'+n+'">'+e.innerHTML+"</div>";c===s.DEFAULT&&(r=(r=r.replace(/&amp;T[0-9]{6};/g,"〿")).replace(/&amp;MT[0-9]{5};/g,"〿"));const d=(new DOMParser).parseFromString(r,"application/xml");c===s.MANYO&&preprocessInlineNote(d,o,["割書","送り"],[],j);const f=showAppPlace(d,o,l,!1,j);c===s.MANYO&&postprocessInlineNote(d);const u=(new XMLSerializer).serializeToString(d),m=$(u);let g;h.append(m),k.append(h);const b={};c===s.MANYO&&(a="",m.find("subst").each(function(){const t=$(this);let e=0;t.find("del").each(function(){e=$(this).text().length;const t=this.getAttribute("type")||this.getAttribute("data-type");t&&(this.title=t)}),t.find("add").each(function(){const t=$(this).text().length;$(this).css({top:-e+"em","margin-bottom":-t+"em"});const n=this.getAttribute("type")||this.getAttribute("data-type");n&&(this.title=n)})}),m.find(".note").each(function(t,e){const n=$(e),o=getCjkDecimal(X),i=n.attr("data-target"),s=i||n.attr("xml:id"),c=n.attr("data-targetend"),l=n.attr("data-type")||"",r=n.attr("data-subtype"),d=n.attr("data-place"),h="("+X+") ",f=l+(r?" "+r:""),u=n.attr("data-n");if(u&&parseInt(u,10)!==X){const t="脚注番号"+X+"（"+n.attr("xml:id")+"）以降にズレが生じています。";console.log(t),g||($("#errors").append($("<div>").addClass("color-red").text(t)),g=!0)}if(s&&c){n.attr("title",h+f);const t=l?"［"+l+"］":l,i=$(e.cloneNode(!0));i.find("add").each(function(){$(this).removeAttr("style")});const s=Z({eliminateSelector:".note"});K(i,s),a+='<div class="app" data-n="'+String(X)+'"><div class="appnum" title="クリックでハイライト切り替え">'+o+'</div><div class="note">'+t+i.html()+"</div></div>",p&&console.debug(String(X)+"："+n.text()+" → "+m.find(".ct[data-n='"+String(X)+"']").text()+" "+n.attr("xml:id")),X++}else if(n.attr("title",f),c){const t="<note>要素「"+n.text()+"」は、xml:idまたは範囲の始まりが設定されていません。";console.log(t),$("#errors").append($("<div>").addClass("color-red").text(t))}if(l&&l.match(F)){const t=B(i),e=$("#"+t),n=$("<span>").attr("id",Y(i));e.after(n)}u&&(b[u]={place:d,type:l})}),m.find("span.ct").each(function(t,e){const n=e.getAttribute("data-n");if(n){const t=b[n];t&&(t.place&&e.setAttribute("data-note-place",t.place),t.type&&e.setAttribute("data-note-type",t.type))}}),""!==a&&(M=!0,w.addClass("display-none"),w.append(a),w.removeClass("display-none")));for(let t of f){let e=getCjkDecimal(t.anchorNo);"appToNotFound"===t.type?e+="：範囲の終わり "+t.appTo+" がありません":"duplicate"===t.type&&(e+="：範囲の始まり "+t.appFrom+" と終わり "+t.appTo+" が同一のもの（"+getCjkDecimal(t.anchorNoRef)+"）があります"),$("#errors").append($('<div style="font-size:1em">').attr({"data-n":t.anchorNo}).addClass("ft app").text(e))}}),A){if(H.includes("front")||H.includes("back")){const e=$("#textstructures");e.append(b("テキスト構造"));const n=$("<div>").addClass("d-flex"),a=$("<div>").addClass("row align-items-center");let o=0;const i=["front","body","back"];for(const t of H){if(t){let e=t;const n="textstructureChecks"+o,s=$("<div>").addClass("col col-auto"),c=$("<div>").addClass("form-check"),l=$("<input>").addClass("form-check-input").attr({type:"checkbox",name:"textstructureChecks",id:n,value:t}).prop("checked",i.includes(t)),r=$("<label>").addClass("form-check-label").attr({for:n}).text(e);c.append(l).append(r),s.append(c),a.append(s)}o++}n.append(a),e.append(n),$("#textstructures").on("change",'input[name="textstructureChecks"]:checkbox',function(){const t=$(this).val();if(t){const e=$(".text > ."+t);$(this).prop("checked")?e.removeClass("display-none"):e.addClass("display-none")}}),t.showTextStructures||e.hide()}const e=[["sic","corr"],["orig","reg"]],n=[!1,!1];if(r.find("choice").each(function(){let t=0;for(const a of e){for(const e of a)$(this).find(e).length>0&&(n[t]=!0);t++}}),n.includes(!0)){const a=$("#choice");a.append(b("Choice"));const o=$("<div>").addClass("d-flex");let i=0;for(const t of n){const n=e[i];if(t){const t=$("<div>").addClass("row align-items-center");let e=n.join("/");const a=$("<label>").addClass("col col-form-label py-0").text(e);t.append(a);let s=0;for(const e of n){let n=e;const a="choiceRadios"+i+"_"+s,c=$("<div>").addClass("col"),l=$("<div>").addClass("form-check"),r=$("<input>").addClass("form-check-input").attr({type:"radio",name:"choiceRadios"+i,id:a,value:e,"data-choice-part-tags-index":i}).prop("checked",0===s),d=$("<label>").addClass("form-check-label").attr({for:a}).text(n);l.append(r).append(d),c.append(l),t.append(c),o.append(t),s++}}i++}a.append(o),$("#choice").on("change",'input[name^="choiceRadios"]:radio',function(){const t=$(this).val();if(t){const n=parseInt($(this).attr("data-choice-part-tags-index"),10),a="choice-highlight";for(const o of e[n]){const e=$(".body-result,.bottom-result").find(o);t===o?(P||e.addClass(a),e.removeClass("display-none"),P||setTimeout(function(){e.removeClass(a)},100)):(P||e.removeClass(a),e.addClass("display-none"))}c===s.MANYO&&W()}}),t.showChoice||a.hide()}}}),$('input[name="textstructureChecks"]:checkbox').change(),$('input[name^="choiceRadios"]:radio:checked').change(),t.enableFileDescTab&&A){const t="fileDescTab",e=nt(t,"書誌");$("#main_tab").append(e.tab),$("#main_tab_content").append(e.tabPane);const n=e.tabPaneContent,a=$("<div>").addClass("pe-2 overflow-y-auto flex-grow-1");R&&a.append(R),z&&a.append(z),n.append(a)}if(t.enableXmlidListPickup&&Object.keys(L).length>0&&A){const e="xmlidlists",n=nt(e,"一覧");$("#main_tab").append(n.tab),$("#main_tab_content").append(n.tabPane),Q(),setTimeout(function(){const a=n.tabPaneContent,o=$("<ul>").addClass("nav nav-tabs").attr({role:"tablist"}),i=$("<div>").addClass("tab-content");let l=1;for(const n in L){const a=t.xmlidListPickupDict[n]||n,r=at(e,a,l);o.append(r.tab),i.append(r.tabPane);const d=L[n];let p="";for(const e of d){const a=B(e),o=$("#"+a);let i;if(t.xmlidListPickupOption[n].contentSelector)i=o.attr(t.xmlidListPickupOption[n].contentSelector);else if(c===s.MANYO){const e=o.clone();let a=t.xmlidListPickupOption[n];const s=Z(a);K(e,s),i=e.text()}else i=o.text();const l=document.createElement("li");let r="list-group-item xmlid-list-item";t.xmlidListPickupOption[n].truncate&&(r+=" text-truncate"),l.className=r,l.setAttribute("data-listed-id",a),l.textContent=i;const d=l.outerHTML;p+=d}const h='<div><ul class="list-group list-group-flush">'+p+"</ul></div>";r.tabPane.html(h),l++}a.append(o).append(i),tt()},0)}if(Object.keys(E).length>0&&A){const e="xmlidrefs",n=nt(e,"参照関係");$("#main_tab").append(n.tab),$("#main_tab_content").append(n.tabPane),Q(),setTimeout(function(){const a=n.tabPaneContent;c!==s.MANYO&&a.append(b("xml:id"));const o=$("<ul>").addClass("nav nav-tabs").attr({role:"tablist"}),l=$("<div>").addClass("tab-content");let r=1;for(const n in E){const a=t.xmlidPickupDict[n]||n,s=at(e,a,r);o.append(s.tab),l.append(s.tabPane);const c=E[n];let d=!1,p="",h=1;for(const t in c){const a=e+"_accordion_collapse_"+r+"_"+h,o=c[t],s=o.corresps,l=o.sameAses,f=o.wits,g=o.facses,b=o.targets,y=s?s.length:0,v=l?l.length:0,C=f?f.length:0,A=g?g.length:0,k=b?b.length:0,w=y+v+C+A+k,_=u(t,x,{selector:n,rubyEliminate:!0,notAppendXmlId:!0}),S=document.createElement("span");S.className="xmlid-on-header",S.setAttribute("data-target-xmlid",t),S.textContent=t;const N=S.outerHTML,E='<span class="flex-fill bold">'+_+"（"+N+"）</span>",T=G(t,n);let L="";for(const t of T){const e=document.createElement("a");e.className="ms-1",e.setAttribute("href",t.url),e.setAttribute("target","_blank"),e.setAttribute("title",t.type),e.innerHTML='<i class="fas fa-external-link-alt"></i>';const n=e.outerHTML;L+=n}if(n===i&&A){const e=document.createElement("a");e.className="ms-1 image-link",e.setAttribute("href","#"),e.setAttribute("data-target-xmlid",t),e.innerHTML='<i class="far fa-image"></i>';const n=e.outerHTML;L+=n}if("person"===n&&y){const e=[];for(const t of s){const n=t.id;if(n){const t=$("#"+n);if(t){const n=t.attr("data-facs"),a=V(n);a.forEach(function(t){-1===e.indexOf(t)&&e.push(t)})}}}if(e.length){const n=document.createElement("a");n.className="ms-1 person-image-link",n.setAttribute("href","#"),n.setAttribute("data-corresp-ref-facs",e.join(" ")),n.setAttribute("data-target-xmlid",t),e.length>1?n.innerHTML='<i class="fas fa-images"></i>':n.innerHTML='<i class="far fa-image"></i>';const a=n.outerHTML;L+=a}}const O='<span class="badge bg-primary rounded-pill float-end mx-2">'+w+"</span>",M=E+L+O,P=document.createElement("button");P.className="accordion-button collapsed focus-ring focus-ring-light",P.setAttribute("type","button"),P.setAttribute("data-bs-toggle","collapse"),P.setAttribute("data-bs-target","#"+a),P.innerHTML=M;const D=P.outerHTML,I='<h2 class="accordion-header">'+D+"</h2>";let j="";if(w){j='<div class="mb-2">参照している箇所 <i class="bi bi-info-circle info-about-mouseover" data-bs-toggle="tooltip"></i>';let t="";if(y){t="";for(const e of s){const n=m(e.elem),a=document.createElement("li");a.className="list-group-item xmlid-ref-list-item",a.setAttribute("data-ref-id",e.id),a.textContent=n;const o=a.outerHTML;t+=o}j+='<ul class="list-group" data-ref-type="corresp">'+t+"</ul>"}if(v){t="";for(const e of l){const n=m(e.elem),a=document.createElement("li");a.className="list-group-item xmlid-ref-list-item",a.setAttribute("data-ref-id",e.id),a.textContent=n;const o=a.outerHTML;t+=o}j+='<ul class="list-group" data-ref-type="sameas">'+t+"</ul>"}if(C){t="";for(const e of f){const n=m(e.elem),a=document.createElement("li");a.className="list-group-item wit-list-item",a.setAttribute("data-n",e.n),a.textContent=n;const o=a.outerHTML;t+=o}j+='<ul class="list-group">'+t+"</ul>"}if(A){t="";for(const e of g){const n='<i class="far fa-image"></i>',a=document.createElement("li");a.className="list-group-item xmlid-ref-list-item",a.setAttribute("data-ref-id",e.id),a.innerHTML=n;const o=a.outerHTML;t+=o}j+='<ul class="list-group" data-ref-type="facs">'+t+"</ul>"}if(k)if(d){j="";const t='<div class="mb-2">参照している箇所</div>',e='<div class="my-2">解説</div>',n=[t,e],a=["",""];for(const t of b){let e=0;const n=$("#"+t.id);if(n){const t=n.parent()[0];t&&"notegrp"===t.tagName.toLowerCase()&&t.hasAttribute("type")&&"解説"===t.getAttribute("type")&&(e=1)}let o=m(t.elem);if(1===e){const t=n.attr("data-resp");t&&(o+="（"+t.replace(/#/,"")+"）")}const i=document.createElement("li");i.className="list-group-item xmlid-ref-list-item",i.setAttribute("data-ref-id",t.id),i.textContent=o;const s=i.outerHTML;a[e]+=s}for(let t=0;t<n.length;t++)a[t].length&&(j+=n[t],j+='<ul class="list-group" data-ref-type="target">'+a[t]+"</ul>")}else{t="";for(const e of b){const n=m(e.elem),a=document.createElement("li");a.className="list-group-item xmlid-ref-list-item",a.setAttribute("data-ref-id",e.id),a.textContent=n;const o=a.outerHTML;t+=o}j+='<ul class="list-group" data-ref-type="target">'+t+"</ul>"}}const U=document.createElement("div");U.className="accordion-collapse collapse",U.setAttribute("id",a),U.innerHTML='<div class="accordion-body">'+j+"</div>";const R=U.outerHTML,z='<div class="accordion-item">'+I+R+"</div>";p+=z,h++}const f='<div class="accordion accordion-flush">'+p+"</div>";s.tabPane.html(f),r++}a.append(o).append(l),C(),tt()},0)}function G(t,e){const n=[];if(e){const a=E[e];t in a&&$(a[t].node).find("idno").each(function(){const t=$(this).attr("type"),e=$(this).text();if(e)if(/^https?:\/\//.test(e))n.push({url:e,type:t});else{let a;"DOI"===t?a="https://doi.org/":"VIAF"===t&&(a="https://viaf.org/viaf/"),a&&n.push({url:a+e,type:t})}})}return n}t.enableSearch&&A&&function(){const t=nt("search","検索");$("#main_tab").append(t.tab),$("#main_tab_content").append(t.tabPane);const e=t.tabPaneContent,n=$("<div>").addClass("tab-pane-content");e.append(n);const a=$("<div>").addClass("input-group mb-3"),o=$("<input>").addClass("form-control").attr({type:"text",name:"searchText"}),i=$("<button>").addClass("btn btn-outline-secondary").attr({type:"button",id:"search_button"}).text("検索");a.append(o).append(i),n.append(a);const s=$("<div>"),c=$("<div>");let l=0;const r={};for(const[t,e]of Object.entries(H)){const n="searchConds"+l,a=et(n,e.label||t,t,e.checked,"searchConditions",!0);if(e.hidden&&a.hide(),s.append(a),a.on("change",J),e.subConditions){const a=$("<span>").addClass("me-2").text(t+"："),o=$("<div>").append(a),i="searchConditions"+l+"Sub";r[t]=i;let s=0;for(const[t,n]of Object.entries(e.subConditions)){const e="searchConds"+l+"Sub"+s,a=et(e,n.label||t,t,n.checked,i,!0);n.hidden&&a.hide(),o.append(a),s++}e.checked?o.show():o.hide(),$("#right_panel").on("change","#"+n,function(){$(this).prop("checked")?o.show():o.hide()}),c.append(o)}l++}if(l>=5){const t=$("<button>").attr({id:"search_conditions_all_check_uncheck",type:"button"}).addClass("btn btn-outline-secondary btn-sm");t.on("click",function(){const t=!(0===$('input[type="checkbox"][name="searchConditions"]:not(:checked)').length);$('input[type="checkbox"][name="searchConditions"]').prop("checked",t).change()}),s.append(t)}n.append(s).append(c),J();const d=$("<div>").addClass("mt-2").attr({id:"serach_result_count"});n.append(d);const p=$("<div>").attr({id:"serach_result"}).addClass("overflow-y-auto");n.append(p),i.on("click",function(){d.empty(),p.empty();let t=0;const e=$("<ul>").addClass("list-group list-group-flush border"),n=o.val(),a=new RegExp(n,"iu"),i=[],s={};$('input[type="checkbox"][name="searchConditions"]:checked').each(function(){const t=$(this).val();if(t in H){const a=H[t],o=[];if(a.subConditions){const e=r[t];e&&$('input[type="checkbox"][name="'+e+'"]:checked').each(function(){const t=$(this).val(),e=a.subConditions[t];e.selector&&o.push(e.selector)})}const c=o.join(",");if(a.persName&&"person"in E)if(t in s||(s[t]=[]),n in E.person){let e=!0;c&&0===$("<div>").append(E.person[n].node).children(c).length&&(e=!1),e&&s[t].push(n)}else $(".body-result").find(".persname").each(function(){e(this,c,!0)}),0===s[t].length&&$(".body-result").find(".persname").each(function(){e(this,c,!1)});let l=a.selector;!a.persName&&c&&(l=c),l&&i.push(l)}function e(e,a,o){const i=$(e).clone(),c=Z();K(i,c);const l=i.text();let r;if(r=o?!(l!==n):l.includes(n)){let e=i.attr("data-corresp");if(e&&(e=e.replace(/^#/,""))){let n=!0;e in E.person&&a&&0===$("<div>").append(E.person[e].node).children(a).length&&(n=!1),n&&(s[t].includes(e)||s[t].push(e))}}}});const c={};$('input[type="checkbox"][name="searchConditions"]:checked').each(function(){const t=$(this).val();if(t in H){const e=H[t],n=[];if(e.subConditions){const a=r[t];a&&$('input[type="checkbox"][name="'+a+'"]:checked').each(function(){const t=$(this).val(),a=e.subConditions[t];a.selector&&n.push(a.selector)})}const a=n.join(",");let o=e.selector;!e.persName&&a&&(o=a),o&&$(".body-result").find(o).each(function(){const e=getElementXPath(this);e in c||(c[e]=t)})}});const l=i.join(","),h={};$(".body-result").find(l).each(function(){const n=$(this).clone(),o=getElementXPath(this);if(o in h)return;let i,l={};o in c&&(i=c[o])&&(l=H[i]);const r=Z(l);K(n,r);let d=void 0;if(l.persName&&(d=!1,i in s))for(const t of s[i]){const e=n.attr("data-corresp")||n.attr("corresp")||n.attr("data-resp")||n.attr("resp");if(t&&e){const n=e.split(" ");n.includes("#"+t)&&(d=!0)}}const p=n.text();if(void 0===d)try{d=p.match(a)}catch(t){console.log(t)}if(d){const n=$(this);let a=p;if(l.resultXPathSelector){const t=n.xpath(l.resultXPathSelector);if(t&&t.length){const e=t.clone();K(e,r),a=e.text()}}if(l.additionalContentSelector){const t=n.attr(l.additionalContentSelector);t&&(a="（"+t+"）"+a)}const s=$("<li>").addClass("list-group-item").text(a),c=n.attr("data-type");if(c){let t=c;const e=n.attr("data-subtype");e&&(t+=" "+e),s.attr("title",t)}s.on("mouseover mouseout click",function(t){const e=!("mouseout"===t.type),a="click"===t.type||t.shiftKey;_(e,$(this),n,"xmlids-highlight","target-highlight",a)}),e.append(s),t++,h[o]=i}});const f=$("<div>").addClass("my-2"),u="検索結果："+t+"件";t?f.html(u+' <i class="bi bi-info-circle info-about-mouseover" data-bs-toggle="tooltip"></i>'):f.text(u),d.append(f),t&&(p.append(e),C()),$("#serach_result").mark(n)}),o.on("keyup",function(t){13===t.which&&i.click()})}();function Z(t){let e=".artifact,.note,rt,rdg,.rdg,del";if(t&&("eliminateSelector"in t?e=t.eliminateSelector:"additionalEliminateSelector"in t&&(e=".artifact,.note,rt,rdg,.rdg,del,"+t.additionalEliminateSelector),"notEliminateSelector"in t)){const n=e.split(","),a=t.notEliminateSelector.split(","),o=[];for(const t of n){const e=t.trim();let n=!0;for(const t of a){const a=t.trim();if(e===a){n=!1;break}}n&&o.push(e)}e=o.join(",")}return e}function K(t,e){return e&&t.find(e).each(function(){$(this).empty()}),t.find("sic,corr,orig,reg").each(function(){$(this).hasClass("display-none")&&$(this).empty()}),t}function J(){const t=0===$('input[type="checkbox"][name="searchConditions"]:not(:checked)').length?"全解除":"全選択";$("#search_conditions_all_check_uncheck").text(t)}if(A){if(t.showLegends){const t=$("#legends").append(b("凡例"));let e=[];e=c===s.MANYO?[{text:"合点",class:"manyo-note-gatten",selector:'.note[data-type="合点"]'},{text:"注",class:"manyo-note-cyuu",selector:'.note[data-type="注"]'},{text:"異文",class:"manyo-note-ibun",selector:'.note[data-type="異文"]'},{text:"送り",class:"manyo-note-okuri",selector:'.note[data-type="送り"]'},{text:"異訓",class:"manyo-note-ikun",selector:'.note[data-type="異訓"]'},{text:"訓",class:"manyo-note-kun",selector:'.note[data-type="訓"]'}]:[{text:"<persName>",class:"persname",selector:".persname"},{text:"<app>",class:"ct",selector:".ct"},{text:"<app>",class:"ct-no-highlight",selector:".ct"},{text:"<note>",class:"note-hover",selector:".note"},{text:"@corresp",class:"corresp-highlight",selector:"[corresp],[data-corresp]"},{text:"@sameAs",class:"sameas-highlight",selector:"[sameAs],[data-sameas]"},{text:"<figure>",class:"figure-highlight",selector:"figure"},{text:"<l>",class:"l",selector:".l"}];let n=!1;for(const a of e){const e=k.find(a.selector).length;if(e){const e=$("<span>").text(a.text).addClass(a.class).addClass("me-2");t.append(e),n=!0}}n||t.hide()}if((c===s.WAKASHUU||c===s.UTAAWASE||O||M)&&$("#additionalUIs").append(b("表示オプション")),O){const t=et("checkbox-kunten","訓点を表示",'.metamark[data-function="kaeri"]',!0);$("#additionalUIs").append(t)}if(M)if(c===s.MANYO);else{const t=et("checkbox-footnote","脚注を表示","#bottom_result",!0);$("#additionalUIs").append(t)}else w.hide();if(t.aboutUrl){$("#help").append(b("ヘルプ"));const e=$("<a>").attr({target:"_blank",href:t.aboutUrl}).text("このビューワについて");$("#help").append(e)}}t.enableBodyResize&&($("#text_body"+(h||"")).resizable({handles:"s"}),$("#text_bottom").addClass("text-body-resizable"));$("#left_col").removeClass("order-1"),P=!1,ct(),it=void 0!==ot||void 0;it&&ct(!0);if(f){const t='[data-xmlid="'+f+'"]';v(t);const e=$(t);e.css("transition","background-color 1s ease"),e.addClass("initial-highlight"),setTimeout(function(){e.removeClass("initial-highlight"),setTimeout(function(){e.css("transition","")},1500)},3e3)}c===s.MANYO&&(Q(),setTimeout(function(){W(),tt()},0));function Q(){D++}function tt(){0===--D&&$(document).trigger("teiviewer4eaj.ready",I)}function et(t,e,n,a,o,i,s){const c=$("<div>").addClass("form-check");i&&c.addClass("form-check-inline");const l=s||"checkbox",r=$("<input>").addClass("form-check-input").attr({type:l,id:t,value:n});o&&r.attr({name:o}),a&&r.prop({checked:!0});const d=$("<label>").addClass("form-check-label").attr({for:t}).text(e);return c.append(r).append(d),c}function nt(t,e){const n=$("<li>").addClass("nav-item").attr({role:"presentation"}),a=t+"_tab",o=t+"_tab_pane",i=$("<button>").addClass("nav-link").attr({id:a,"data-bs-toggle":"tab","data-bs-target":"#"+o,type:"button",role:"tab","aria-controls":o,"aria-selected":!1}).text(e);n.append(i);const s=$("<div>").addClass("tab-pane fade top-tab-pane").attr({id:o,role:"tabpanel","aria-labelledby":a,tabindex:0}),c=$("<div>").addClass("my-2 tab-pane-content").attr({id:t});return s.append(c),{tab:n,tabPane:s,tabPaneContent:c}}function at(t,e,n){const a=$("<li>").addClass("nav-item").attr({role:"presentation"}),o=t+"_tab_"+n,i=t+"_tab_pane_"+n,s=$("<button>").addClass("nav-link").attr({id:o,"data-bs-toggle":"tab","data-bs-target":"#"+i,type:"button",role:"tab","aria-controls":i,"aria-selected":!1}).text(e);1===n&&s.addClass("active"),a.append(s);const c=$("<div>").addClass("tab-pane fade sub-tab-pane").attr({id:i,role:"tabpanel","aria-labelledby":o,tabindex:0});return 1===n&&c.addClass("show active"),{tab:a,tabPane:c}}})(o,h,f).then(()=>{g.stop()})}function f(t,e,n){const a=$(t),o=a.find(e+'[type="main"]');if(o.length)return n.rubyEliminate?m(o[0]):$(o[0]).text();const i=a.find(e);return i.length?n.rubyEliminate?m(i[0]):$(i[0]).text():void 0}function u(t,n,a){const o=a||{},i=e[n||0];function s(t,e){const n=i[t];if(e in n){let o;o=a.rubyEliminate?m(n[e].node):n[e].text;let i=t;const s=t.replace(">"," ").split(" ");return s.length>0&&(i=s[s.length-1]),"person"===i?o=f(n[e].node,"persName",a):"place"===i&&(o=f(n[e].node,"placeName",a)),o}}let c="";if(o.selector)c=s(o.selector,t);else for(const e in i)if(c=s(e,t))break;return t&&(c||(c=""),c&&o.insertBreakBeforeXmlId&&(c+="\n"),o.notAppendXmlId||(c+="（"+t+"）")),c}function m(t){return g(t,["rt","rdg,.rdg",".artifact"])}function g(t,e){const n=$(t).clone();for(const t of e)t&&n.find(t).each(function(){$(this).text("")});return n.text()}function b(t){return $("<div>").addClass("heading1").text(t)}function y(t){return $("<div>").addClass("heading2").text(t)}function v(t){x(document.querySelector(t))}function x(t){if(t){const e=$(t).closest(".body-result,.bottom-result");if(e.length){const n=e[0],a=t.getBoundingClientRect();if(0===a.x&&0===a.y&&0===a.width&&0===a.height);else{const e=n.getBoundingClientRect(),o=0;let i=0;if("vertical-rl"===$(t).css("writing-mode")){i=e.width<a.width?e.width*(1-o)-a.width:(e.width-a.width)/2;const t=a.left-e.left-i;n.scrollBy({left:t,top:0,behavior:"smooth"})}else{i=e.height<a.height?e.height*o:(e.height-a.height)/2;const t=a.top-e.top-i;n.scrollBy({left:0,top:t,behavior:"smooth"})}}}}}function C(){$(".info-about-mouseover").each(function(){new bootstrap.Tooltip(this,{title:A})})}function A(){return"リストの クリック または Shiftキー＋マウスオーバー で本文がスクロールします"}function k(t,e){{const n=".manyo span.ct",a=n+"[data-n='"+t+"']",o="ct-no-highlight";$(n).removeClass(o),e&&$(a).addClass(o)}{const n=".manyo span.note",a=n+"[data-n='"+t+"']",o="note-highlight";$(n).removeClass(o),e&&$(a).addClass(o)}{const n=".app",a=n+"[data-n='"+t+"']",o="app-highlight";$(n).removeClass(o),e&&$(a).addClass(o)}}$(".file_input1").change(function(){$('#input1 input[type="file"]').hide();for(let t=0;t<this.files.length;++t)if("text/xml"===this.files[t].type){$("#input1").append(this.files[t].name),$("#row2").remove();const e=new FileReader;e.onload=function(t){h($.parseXML(t.target.result))},e.readAsText(this.files[t],"UTF-8");break}}),$("body").on("click mouseover mouseout",".ft",function(t){const e=".app[data-n='"+$(this).attr("data-n")+"']";$(".app").removeClass("app-highlight"),"click"===t.type&&v(e),"click"!==t.type&&"mouseover"!==t.type||$(e).addClass("app-highlight")}),$("body").on("click mouseover mouseout",".appnum",function(t){const e=$(this).closest(".app").attr("data-n"),n="app-highlight";{const a=".ct",o=a+"[data-n='"+e+"']";if($(a).removeClass(n),"click"===t.type){v(o);const t=$(this).find(".cthltgl"),e="ct-no-highlight";$(o).toggleClass(e),$(o).hasClass(e)?t.html('<span class="ui-icon ui-icon-radio-off"></span>'):t.html('<span class="ui-icon ui-icon-radio-on"></span>')}"click"!==t.type&&"mouseover"!==t.type||$(o).addClass(n)}{const a=".ft",o=a+"[data-n='"+e+"']";$(a).removeClass(n),"click"!==t.type&&"mouseover"!==t.type||$(o).addClass(n)}}),$("body").on("mouseover mouseout",".note",function(t){if(c===s.MANYO){t.stopPropagation();let e=$(this).attr("data-n");e||(e=$(this).closest(".app").attr("data-n")),k(e,"mouseover"===t.type)}}),$("body").on("click",".note",function(t){if(c===s.MANYO){let e,n=$(this).attr("data-n");if(n||(n=$(this).closest(".app").attr("data-n"),e=!0),!e){t.stopPropagation();const e=".app"+"[data-n='"+n+"']",a="app-highlight";$(e).addClass(a),v(e)}}}),$("body").on("mouseover mouseout",".ct",function(t){if(c===s.MANYO){k($(this).attr("data-n"),"mouseover"===t.type)}}),$("body").on("click",".ct",function(){if(c===s.MANYO){const t=".app",e=t+"[data-n='"+$(this).attr("data-n")+"']",n="app-highlight";$(t).removeClass(n),$(e).addClass(n),v(e)}}),$("#right_col").on("click","#checkbox-kunten,#checkbox-footnote,#checkbox-win-or-lose,#checkbox-kokkataikannum",function(){const t=$(this).prop("checked"),e=$($(this).val());t?e.removeClass("display-none"):e.addClass("display-none")});const w={};function _(t,e,n,a,o,i){t?(e.addClass(a),n.addClass(o),i&&n.length&&n.each(function(){x(this)})):(e.removeClass(a),n.removeClass(o))}function S(){let t;do{t=Math.random().toString(16).substr(2,8)}while(t in o);return o[t]=!0,t}function N(t,e,a,o){if(!t[0])return;const i=o||{},s=i.key||e,c=n[a||0];c[s]={};const l=e.toLowerCase();let r="["+e+"]";i.noNeedForData||(r+=",[data-"+l+"]"),t[0].querySelectorAll(r).forEach(function(t){const n=t.getAttribute(e)||t.getAttribute("data-"+l);if(n){const e=n.split(" ");if(e.length){let n;t.id?n=t.id:(n=S(),t.id=n),e.forEach(function(e){if(e&&(e=e.replace(/^#/,""))){const a={id:n,elem:t};e in c[s]?c[s][e].push(a):c[s][e]=[a]}})}}})}function E(t,e,n){let a=$();return t[0].querySelectorAll("["+n+'~="#'+e+'"],[data-'+n+'~="#'+e+'"]').forEach(function(t){a=a.add(t)}),a}$("#right_col").on("change",'input[name="versionRadios"]:radio',function(){const t=$(this).val(),e="#"+t;0===Object.keys(w).length&&$("#bottom_result").children(".app[data-n]").each(function(){const t=$(this).attr("data-n");$(".ct[data-n='"+t+"']").each(function(){return t in w||(w[t]=$(this).html()),!1})});let n=!1;$("#bottom_result").children(".app[data-n]").each(function(){const a=$(this),o=a.attr("data-n"),i=t?a.children('.rdg[data-n="'+o+'"][data-wit~="'+e+'"]'):[],s=i.length?i:a.find('.lem[data-n="'+o+'"]');let c="";s.length?s.each(function(){$(this).children(".footnote-content").each(function(){c=$(this).html()})}):(c=w[o]||"",n=!0);$(".ct[data-n='"+o+"']").each(function(){$(this).html(c)})}),n&&$('input[name^="choiceRadios"]:radio:checked').change()}),$("#right_col").on("mouseover mouseout click",".xmlid-on-header",function(t){const e=$(this).attr("data-target-xmlid"),n=$("body").find('[xml\\:id="'+e+'"]'),a=!("mouseout"===t.type),o="click"===t.type||t.shiftKey;_(a,$(this),n,"xmlids-highlight","xmlids-highlight",o)}),$("#right_col").on("mouseover mouseout click",".xmlid-list-item",function(t){const e=$(this).attr("data-listed-id"),n=$("#"+e),a=!("mouseout"===t.type),o="click"===t.type||t.shiftKey;_(a,$(this),n,"xmlids-highlight","xmlids-highlight",o)}),$("#right_col").on("mouseover mouseout click",".xmlid-ref-list-item",function(t){const e=$(this).attr("data-ref-id"),n=$("#"+e),a=$(this).parent().attr("data-ref-type")+"-highlight",o=!("mouseout"===t.type),i="click"===t.type||t.shiftKey;_(o,$(this),n,"xmlids-highlight",a,i),V(n.attr("data-facs")).forEach(function(t){$('.offcanvas-for-images-osds[data-target-xmlid="'+t+'"]').each(function(){o?($(this).addClass("highlight"),function(t){const e=document.getElementById("offcanvas_for_images_body"),n=t.getBoundingClientRect(),a=e.getBoundingClientRect();let o=0;o=a.height<n.height?0*a.height:(a.height-n.height)/2;const i=n.top-a.top-o;e.scrollBy({left:0,top:i,behavior:"smooth"})}(this)):$(this).removeClass("highlight")})})}),$("#right_col").on("mouseover mouseout click",".wit-list-item",function(t){const e=$(this).attr("data-n"),n=$("body").find('.ct[data-n="'+e+'"],.ft[data-n="'+e+'"]'),a=!("mouseout"===t.type),o="click"===t.type||t.shiftKey;_(a,$(this),n,"xmlids-highlight","wit-highlight",o)});let T=0;const O={};function M(e,n,a,o,i,s,c){if(e){if($(n).addClass(s),a.addClass(s),t.enableGraph){const t=i?n:a,s=i?a:n,l=function(t,e,n,a){"length"in t||(t=[t]);"length"in e||(e=[e]);const o=t.length,i=e.length;let s=[];s=$.isArray(n)?n:[n];let c=s;for(const t of e)if(t){const e=$(t).attr("xml:id");if(e){const t=c.filter(t=>t!==e);c=t}}const l=(s=c).length;let r;if(o>0&&i+l===1){let n="";const o=1===i?e[0]:void 0;1===i&&(r=$(o).attr("xml:id")),r||1!==l||(r=s[0]);const c=P(o,r,a);for(const e of t){const t=P(e),a=D(e);n+=' "'+t+'" -> "'+c+'" '+a+" \n"}let d="digraph {";return d+="bgcolor=transparent ",d+="rankdir=LR ",d+=n,d+="}",n?d:""}if(1===o&&i+l>1){let n="";const o=t,i=P(o),c=D(o);for(const t of e){r=t?$(t).attr("xml:id"):s.shift();const e=P(t,r,a);n+=' "'+i+'" -> "'+e+'" '+c+" \n"}for(const t of s){const e=P(void 0,t,a);n+=' "'+i+'" -> "'+e+'" '+c+" \n"}let l="digraph {";l+="bgcolor=transparent ",l+="rankdir=LR ",l+=n,l+="}";const d=n?l:"";return d}return""}(t,s,o,c);if(l){const t="xmlidgraph"+T;$(n).attr("data-graphid",t),T++;const e=$("<div>").attr({id:t,role:"alert"}).addClass("dotgraph alert alert-light alert-dismissible fade show mt-2 mb-0");document.documentElement.scrollHeight>document.documentElement.clientHeight||$("body").addClass("overflow-y-hidden"),$("#graph_result").prepend(e),d3.select("#"+t).graphviz({zoom:!1}).renderDot(l).on("end",function(){e.append('<button type="button" class="btn-close" aria-label="Close"></button>'),e.append('<button type="button" class="btn svglink" title="グラフの保存（SVG）"><i class="fas fa-download"></i></button>'),e.append('<button type="button" class="btn pnglink" title="グラフの保存（PNG）"><i class="far fa-file-image"></i></button>')})}j(e,t,s)}}else $(n).removeClass(s),a.removeClass(s),t.enableGraph&&($("#graph_result").find(".dotgraph").each(function(){const t=$(this).attr("id");t in O||(d3.select("#"+t).selectAll("svg").remove(),d3.select("#"+t).graphviz().destroy(),$(this).remove())}),$("body").removeClass("overflow-y-hidden"),j(e))}function P(t,e,n){let a=t?g(t,["rt","rdg,.rdg",".artifact"]):"";if(a&&(a=a.replace(/\n+/g,"\n").replace(/ +/g," ")),a){const t=a.match(/.{1,20}/g);t&&(a=t.join("\n"))}return e&&(a?a+="\n（"+e+"）":a=u(e,n,{insertBreakBeforeXmlId:!0}),a||(a="（"+e+"）")),a}function D(e){let n="";if(e){$.isArray(e)&&e.length>0&&(e=e[0]);const a=$(e);let o=a.attr("type")||a.attr("data-type");if(o&&(o in t.typeToGraphLabelMapping&&(o=t.typeToGraphLabelMapping[o]),n='[label="'+o+'"]'),!n){n='[label="'+(a.attr("data-original-tag-name")||e.nodeName.toLowerCase())+'"]'}}return n}const I=[];function j(t,e,n){for(;I.length;){I.pop().remove()}if(e&&n&&t){const t="length"in e?e:[e],a="length"in n?n:[n];for(const e of t)for(const t of a){const n=new LeaderLine(e,t,{color:"rgba(30, 130, 250, 0.2)"});I.push(n)}}}function U(t,e,n){const a=e.toLowerCase(),o=$(t).attr(e)||$(t).attr("data-"+a);if(o){const e=[],i=[];o.split(" ").forEach(function(t){const n=t.replace(/^#/,"");e.push('[xml\\:id="'+n+'"]'),i.push(n)});const s=$(this).closest(".body-result").attr("id"),c=$(s?"#"+s:"body").find(e.join(",")),l="mouseover"===n.type,r=!0;if(c.length){const e=s&&s.endsWith("2")?1:0;M(l,t,c,i,r,a+"-highlight",e)}}}$(".body-result").on("mouseover mouseout","[corresp],[data-corresp]",function(t){c!==s.MANYO&&(t.stopPropagation(),U(this,"corresp",t))}),$(".body-result").on("mouseover mouseout","[sameAs],[data-sameas]",function(t){c!==s.MANYO&&(t.stopPropagation(),U(this,"sameAs",t))}),$(".body-result").on("mouseover mouseout","[target],[data-target]",function(t){c!==s.MANYO&&(t.stopPropagation(),U(this,"target",t))}),$(".body-result").on("mouseover mouseout","[xml\\:id]",function(t){if(c!==s.MANYO){const e=$(this).attr("xml:id");if(e){const n=$(this).closest(".body-result").attr("id"),a=n?"#"+n:"body",o=E($(a),e,"corresp"),i=$(a).find('[sameAs="#'+e+'"],[data-sameas="#'+e+'"]'),s=E($(a),e,"target"),c="mouseover"===t.type,l=!1,r=o.add(i).add(s);if(r.length){M(c,this,r,e,l,"xmlidref-highlight",n&&n.endsWith("2")?1:0)}}}}),$(".body-result").on("click","[corresp],[data-corresp],[sameAs],[data-sameas],[target],[data-target],[xml\\:id]",function(){const t=$(this).attr("data-graphid");t&&(O[t]=!0)}),$("#graph_result").on("click",".dotgraph .btn-close",function(){const t=$(this).parent().attr("id");d3.select("#"+t).selectAll("svg").remove(),d3.select("#"+t).graphviz().destroy(),$(this).parent().remove(),t in O&&delete O[t]}),$("#graph_result").on("click",".dotgraph .svglink",function(){const t=$(this).parent().find("svg");if(t.length>0){const e=$(t[0]).find("title"),n=e.length>0?$(e[0]).text():$(this).parent().attr("id"),a=(new XMLSerializer).serializeToString(t[0]),o=new Blob([a],{type:"image/svg+xml"}),i=n+".svg",s=URL.createObjectURL(o),c=document.createElement("a");c.href=s,c.download=i,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(s)}}),$("#graph_result").on("click",".dotgraph .pnglink",function(){const t=$(this).parent().find("svg");if(t.length>0){const e=$(t[0]).find("title"),n=e.length>0?$(e[0]).text():$(this).parent().attr("id"),a=(new XMLSerializer).serializeToString(t[0]),o="data:image/svg+xml;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(a))),i=new Image;i.addEventListener("load",function(){const e=document.createElement("canvas");e.width=t[0].width.baseVal.value,e.height=t[0].height.baseVal.value,e.getContext("2d").drawImage(i,0,0);const a=n+".png",o=document.createElement("a");o.href=e.toDataURL("image/png"),o.download=a,document.body.appendChild(o),o.click(),document.body.removeChild(o)}),i.src=o}}),$(".body-result").on("mouseover mouseout","figure",function(e){e.stopPropagation();if("mouseover"===e.type){if($(this).addClass("figure-highlight"),t.enableGraph){const t=function(t){let e=0;function n(t){let n;t.hasAttribute("n")?n=t.getAttribute("n"):(n=(e++).toString(),t.setAttribute("n",n));const a=$(t).children("label");return a.length>0?{nodename:"node"+n.replace(/\./g,"_"),nodelabel:'[label="'+a[0].textContent+'"]'}:null}let a="";return function t(e){let o;if("etree"===e.nodeName.toLowerCase()){const t=n(e);if(t){a+=t.nodename+t.nodelabel+"\n",o=t.nodename;const i=$(e).parent().get(0);if(i&&"etree"===i.nodeName.toLowerCase()){const e=n(i);e&&(a+=e.nodename+" -> "+t.nodename+"\n")}}}if(e.hasChildNodes()){let i=e.childNodes;for(const e of i){const i=e.nodeName.toLowerCase();if("etree"===i)t(e);else if("eleaf"===i){const t=n(e);t&&(a+=t.nodename+t.nodelabel+"\n",a+=o+" -> "+t.nodename+"\n")}}}}(t),a?a="digraph {"+a+"}":""}(this);if(t){const e="xmlidgraph"+T;$(this).attr("data-graphid",e),T++;const n=$("<div>").attr({id:e,role:"alert"}).addClass("dotgraph alert alert-light alert-dismissible fade show mt-2 mb-0");$("#graph_result").prepend(n),d3.select("#"+e).graphviz({zoom:!1}).renderDot(t).on("end",function(){n.append('<button type="button" class="btn-close" aria-label="Close"></button>'),n.append('<button type="button" class="btn svglink" title="グラフの保存（SVG）"><i class="fas fa-download"></i></button>'),n.append('<button type="button" class="btn pnglink" title="グラフの保存（PNG）"><i class="far fa-file-image"></i></button>')})}}}else $(this).removeClass("figure-highlight"),t.enableGraph&&$("#graph_result").find(".dotgraph").each(function(){const t=$(this).attr("id");t in O||(d3.select("#"+t).selectAll("svg").remove(),d3.select("#"+t).graphviz().destroy(),$(this).remove())})}),$(".body-result").on("click","figure",function(){const t=$(this).attr("data-graphid");t&&(O[t]=!0)});let R=null,z=null,H={};function F(t,e){if(e){const n=H[e];if(n){const e=$('g.a9s-annotation[data-id="'+n+'"]');e&&(t?e.addClass("hover"):e.removeClass("hover"))}}}function X(t,e,n){let a;if(n?a=n:e&&(a=$('[data-note-of-xmlid="'+e+'"]')),a){const e="image-note-highlight";t?a.addClass(e):a.removeClass(e)}}function B(t,n){if(n){const a=i,o=e[0];if(o[a]&&n in o[a]){const e=o[a][n];if(e.facses){const n="fac-image-target-highlight-sync";for(const a of e.facses){const e=$("#"+a.id).attr("data-facs-target-id");if(e){const a=$("#"+e);t?a.addClass(n):a.removeClass(n)}}}}}}function Y(e,n){const a=document.querySelector("#home_tab"),o=bootstrap.Tab.getInstance(a);if(o&&o.show(),R){let t=!1;$.isPlainObject(R.tileSources)?R.tileSources.url!==e[0].graphicUrl&&(t=!0):t=!0,t&&q()}if(R)W(e);else{let n=void 0;if(e[0].manifest?n=!0:e[0].graphicUrl&&(n=!1),void 0===n)return;const a=$("<div>").addClass("clearfix"),o=b(n?"en"===d?"IIIF Image":"IIIF画像":"en"===d?"Image":"画像").addClass("float-start"),i=$("<a>").attr("href","javascript:void(0);").addClass("float-end btn btn-sm px-0 py-1").text("en"===d?"Close":"閉じる");if(i.on("click",q),void 0!==it){const t=$("<div>").addClass("form-check form-switch float-start sync-switch"),e=$("<input>").addClass("form-check-input").attr({type:"checkbox",role:"switch",id:"syncSwitch"}),n=$("<label>").addClass("form-check-label").attr({for:"syncSwitch"}).text("本文スクロールと同期");e.prop("checked",it),e.on("change",function(){it=$(this).prop("checked")}),t.append(e).append(n);const s=$("<div>").addClass("form-check form-switch float-start sync-switch"),l=$("<input>").addClass("form-check-input").attr({type:"checkbox",role:"switch",id:"annotBorderSwitch"}),r=$("<label>").addClass("form-check-label").attr({for:"annotBorderSwitch"}).text("枠線表示");l.prop("checked",st),l.on("change",function(){(st=$(this).prop("checked"))?c.removeClass("no-border"):c.addClass("no-border")}),s.append(l).append(r),a.append(o).append(t).append(s).append(i)}else a.append(o).append(i);const s=$("<div>").attr("id","iiif_image").append(a),c=$('<div id="icveframe" class="my-2">');c.css({width:"100%",height:"400px"}),t.openSeadragon.highlight&&st||c.addClass("no-border"),s.append(c),s.insertAfter($("#input1"));const l=n?e[0].canvasInfo+"/info.json":{type:"image",url:e[0].graphicUrl,buildPyramid:!1};(R=OpenSeadragon({id:"icveframe",prefixUrl:"lib/openseadragon-4.1.1/images/",preserveViewport:!0,visibilityRatio:1,minZoomLevel:1,defaultZoomLevel:1,sequenceMode:!1,showHomeControl:!1,showFullPageControl:!1,tileSources:l})).addHandler("open",function(){W(e)})}let i;for(const t of e)if(t.xmlid){const e=E($(n?"#"+n:"body"),t.xmlid,"target");if(!i){const t=$("<div>").attr("id","iiif_image_notes");$("#iiif_image").append(t),i=!0}e.each(function(){const e=$(this).clone();s(e,"iiif-image-notes-image");const n=$("<div>").attr({"data-note-of-xmlid":t.xmlid}).html(e.html());n.on("mouseover mouseout",function(t){const e=$(this).attr("data-note-of-xmlid"),n="mouseover"===t.type;X(n,void 0,$(this)),F(n,e),B(n,e)}),$("#iiif_image_notes").append(n)})}function s(t,e){let n=t.find("graphic");for(;n.length>0;)n.each(function(){const t=replaceWithElement(this,"img");t.hasAttribute("url")||t.setAttribute("src",t.getAttribute("data-url")),e&&t.classList.add(e)}),n=t.find("graphic")}}function W(t,n){function a(t,e,n){let a=parseFloat(t.ulx||0),o=parseFloat(t.uly||0),i=parseFloat(t.lrx||0)-a,s=parseFloat(t.lry||0)-o,c=t.points;if(c){let e,a;if(t.manifest?t.canvasSize&&t.canvasSize.width>0&&t.canvasSize.height>0&&t.canvasInfoSize&&t.canvasInfoSize.width>0&&t.canvasInfoSize.height>0&&(e=t.canvasSize.width/t.canvasInfoSize.width,a=t.canvasSize.height/t.canvasInfoSize.height):t.graphicUrl&&t.graphicSize&&t.graphicSize.width>0&&t.graphicSize.height>0&&(e=1,a=1),void 0===e||void 0===a)return;const o=[];c.split(" ").forEach(function(t){const i=t.match(/(-?[0-9]+(?:\.[0-9]+)?),(-?[0-9]+(?:\.[0-9]+)?)/);if(i){const t=parseFloat(i[1])*e,s=parseFloat(i[2])*a;o.push(t+","+s),n&&n.addPoint(t,s)}}),c=o.join(" ")}else c=a+","+o+" ",c+=a+i+","+o+" ",c+=a+i+","+(o+s)+" ",c+=a+","+(o+s),n&&(n.addPoint(a,o),n.addPoint(a+i,o),n.addPoint(a+i,o+s),n.addPoint(a,o+s));if(c){const n={points:c,xmlid:t.xmlid};e.push(n)}}function o(t){return{"@context":"http://www.w3.org/ns/anno.jsonld",id:"#"+URL.createObjectURL(new Blob).slice(-36),type:"Annotation",body:[],target:{selector:{type:"SvgSelector",value:'<svg><polygon points="'+t+'"></polygon></svg>'}}}}let s;t.length&&(s=new ConvexHullGrahamScan);const c=[];for(const e of t)a(e,c,s);if(c.length){const t=$.isPlainObject(n)&&"targetOsd"in n?n.targetOsd:R;let a=$.isPlainObject(n)&&"targetOsdAnno"in n?n.targetOsdAnno:z;a||(a=OpenSeadragon.Annotorious(t,{disableEditor:!0,disableSelect:!0,readOnly:!0}));var l=a;l.clearAnnotations();const r={};for(const t of c){const e=o(t.points);l.addAnnotation(e,!1),r[e.id]=t.xmlid,H[t.xmlid]=e.id,1===c.length&&l.fitBounds(e,{immediately:!0,padding:20})}if(c.length>0&&s){const t=s.getHull(),e=[];for(const n of t)e.push(n.x+","+n.y);const n=o(e.join(" "));l.formatters=function(){return"no-border"},l.addAnnotation(n,!1),l.formatters=function(){},l.fitBounds(n,{immediately:!0,padding:20})}l.on("mouseEnterAnnotation",function(t){const e=r[t.id];e&&(B(!0,e),X(!0,e))}),l.on("mouseLeaveAnnotation",function(t){const e=r[t.id];e&&(B(!1,e),X(!1,e))}),l.on("clickAnnotation",function(t){if(it){const n=r[t.id];if(n){const t=i,a=e[0];if(a[t]&&n in a[t]){const e=a[t][n];if(e.facses)for(const t of e.facses){const e=$("#"+t.id).attr("data-facs-target-id");if(e){const t=$("#"+e);t.length&&t.each(function(){"param"===this.tagName.toLowerCase()||x(this)})}}}}}})}}function q(){z&&(z.destroy(),z=null),R&&(R.destroy(),R=null),$("#iiif_image").remove(),H={}}$(".body-result,#bottom_result").on("click",".fac-image[data-facs-target-xmlid]",function(){const t=$(this).attr("data-facs-target-xmlid"),n=i,a=$(this).closest(".body-result").attr("id"),o=a&&a.endsWith("2")?1:0,s=e[o],c=[];if(n in s&&t in s[n]){const e=s[n][t];if(e.childZoneXmlIds&&e.childZoneXmlIds.length)for(const t of e.childZoneXmlIds)if(t in s[n]){const e=s[n][t];c.push(e)}(e.manifest||e.graphicUrl)&&(c.push(e),Y(c,a))}}),$(".body-result").on("mouseover mouseout",".fac-image[data-facs-target-id]",function(t){const e=$(this).attr("data-facs-target-id"),n=$("#"+e),a="mouseover"===t.type;a?n.addClass("fac-image-target-highlight"):n.removeClass("fac-image-target-highlight");const o=$(this).attr("data-facs-target-xmlid");F(a,o),X(a,o)}),$(".body-result").on("mouseover mouseout","[facs],[data-facs]",function(t){const e=$(this).attr("facs")||$(this).attr("data-facs"),n="mouseover"===t.type;n?$(this).addClass("fac-image-target-highlight"):$(this).removeClass("fac-image-target-highlight");const a=V(e);for(const t of a)F(n,t),X(n,t)}),$(".body-result").on("click",".facs-image[data-facs-target-xmlids]",function(){const n=$(this).attr("data-facs-target-xmlids").split(" "),a=i,o=$(this).closest(".body-result").attr("id"),s=o&&o.endsWith("2")?1:0,c=e[s];if(a in c&&t.useOpenSeadragon){const t=[],e=[];for(const o of n)if(o in c[a]){const n=c[a][o];n.manifest?t.push(n):n.graphicUrl&&e.push(n)}let i;t.length?i=t:e.length&&(i=e),i&&Y(i,o)}});let G=null;function V(t){const e=[];if(t){t.split(" ").forEach(function(t){t&&(t=t.replace(/^#/,""))&&e.push(t)})}return e}function Z(t){const n=[],a=V(t);if(a.length){const t=i,o=e[0];for(const e of a)if(t in o&&e in o[t]){const a=o[t][e];(a.manifest||a.graphicUrl)&&n.push(a)}}return n}function K(t,e){$("#offcanvas_for_images_title").text(t),$("#offcanvas_for_images_body").empty(),e&&$("#offcanvas_for_images_body").append(e)}function J(){const t=document.querySelector("#offcanvas_for_images");bootstrap.Offcanvas.getOrCreateInstance(t).show()}$(".body-result").on("click",".place-location-geo",function(){const t=[parseFloat($(this).attr("data-lat")),parseFloat($(this).attr("data-lng"))],e=document.querySelector("#home_tab");if(bootstrap.Tab.getInstance(e).show(),G)G.eachLayer(function(t){void 0!==t._icon&&G.removeLayer(t)}),L.marker(t).addTo(G),G.panTo(t);else{const e=$("<div>").addClass("clearfix"),n=b("en"===d?"Map":"地図").addClass("float-start"),a=$("<a>").attr("href","javascript:void(0);").addClass("float-end btn btn-sm px-0 py-1").text("en"===d?"Close":"閉じる");a.on("click",function(){G&&(G.remove(),G=null),o.remove()}),e.append(n).append(a);const o=$('<div class="my-2">').attr("id","map_section").append(e),i=$('<div id="map" class="my-2">');i.css({width:"100%",height:"400px"}),o.append(i),o.insertAfter($("#input1")),G=L.map("map",{center:t,zoom:5}),L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(G),L.marker(t).addTo(G)}}),$(".body-result,.bottom-result").on("wheel",function(t){if(r===l.HORIZONTAL)return;const e=t.originalEvent;Math.abs(e.deltaY)<Math.abs(e.deltaX)||(e.preventDefault(),this.scrollLeft-=e.deltaY)});const Q={};function tt(){for(const t of Object.keys(Q))et(t)}function et(t){if(t in Q){let e=Q[t];e.osdAnno.destroy(),e.osdAnno=null,e.osd.destroy(),e.osd=null,delete Q[t]}}function nt(t,e,n,a){let o=void 0;if(t.manifest?o=!0:t.graphicUrl&&(o=!1),void 0===o)return!1;const i={id:n,prefixUrl:"lib/openseadragon-4.1.1/images/",preserveViewport:!0,visibilityRatio:1,minZoomLevel:1,defaultZoomLevel:1,sequenceMode:!1,showHomeControl:!1,showFullPageControl:!1,tileSources:o?t.canvasInfo+"/info.json":{type:"image",url:t.graphicUrl,buildPyramid:!1},showNavigationControl:!a};if(a){const t={dragToPan:!1,scrollToZoom:!1,clickToZoom:!1};i.gestureSettingsMouse=t,i.gestureSettingsTouch=t,i.gestureSettingsPen=t,i.gestureSettingsUnknown=t,i.zoomPerClick=1,i.zoomPerScroll=1,i.zoomPerDblClickDrag=1}const s=OpenSeadragon(i),c=OpenSeadragon.Annotorious(s,{disableEditor:!0,disableSelect:!0,readOnly:!0});Q[n]={osd:s,osdAnno:c};const l=a?[t]:e;return s.addHandler("open",function(){W(l,{targetOsd:s,targetOsdAnno:c,replaceScreenshot:a})}),!0}function at(t,e,n){if(tt(),!t.length)return;if(J(),K("画像"+(n?"（"+n+"）":"")),e){const e=$("<div>").attr("id","offcanvas_for_images_body_osds"),a="offcanvas_for_images_body_osd",o="offcanvas-for-images-body-osd",i=$("<div>").attr("id",a+"_header").addClass("d-grid d-flex justify-content-end "+o).hide(),s=$("<button>").attr({id:a+"_header_close",type:"button"}).addClass("btn-close "+o).hide();i.append(s);const c=$("<div>").attr("id",a).addClass(o).hide();$("#offcanvas_for_images_body").append(e).append(i).append(c);let l=0;for(const a of t){const o="offcanvas_for_images_body_"+l,i=$("<div>").addClass("img-thumbnail offcanvas-for-images-osds").attr({id:o,"data-target-xmlid":a.xmlid});if(e.append(i),nt(a,t,o,!0)){const t=$("<div>").addClass("offcanvas-for-images-links");if(n&&a.xmlid){const e="body_result",o=E($(e?"#"+e:"body"),n,"corresp");if(o.length){let e=0;for(const n of o){const o=$(n);if(V(o.attr("data-facs")).indexOf(a.xmlid)>-1){e++;const n=o.attr("id"),a=m(o[0]),i=$("<a>").addClass("me-2").attr({href:"#","data-target-id":n,title:a}).text(e);new bootstrap.Tooltip(i[0]),i.on("mouseover mouseout click",function(t){t.preventDefault();const e=$(this).attr("data-target-id"),n=$("#"+e),a=!("mouseout"===t.type),o="click"===t.type||t.shiftKey;_(a,$(this),n,"xmlids-highlight","xmlids-highlight",o)}),t.append(i)}}}i.append(t)}}else i.remove();l++}}else{nt(t[0],t,"offcanvas_for_images_body",!1)}}$("#right_col").on("click",".iiif-image-notes-image",function(){const t=$(this).attr("src");if(t){tt(),J(),K("画像注釈",$("<img>").attr("src",t).addClass("single"))}}),$("#right_col").on("click",".image-link",function(t){t.preventDefault();const e=$(this).attr("data-target-xmlid"),n=$(this).attr("data-target-xmlid");at(Z(e),!1,n)}),$("#right_col").on("click",".person-image-link",function(t){t.preventDefault();const e=$(this).attr("data-corresp-ref-facs"),n=$(this).attr("data-target-xmlid");at(Z(e),!0,n)}),$(document).on("click",".offcanvas-for-images-osds",function(){const t=Z($(this).attr("data-target-xmlid"));if(t.length){$("#offcanvas_for_images_body_osds").hide(),$(".offcanvas-for-images-body-osd").show();const e="offcanvas_for_images_body_osd";nt(t[0],[t[0]],e,!1)}}),$(document).on("click","#offcanvas_for_images_body_osd_header_close",function(){$("#offcanvas_for_images_body_osds").show(),$(".offcanvas-for-images-body-osd").hide();et("offcanvas_for_images_body_osd")});let ot,it=void 0,st=!0;function ct(t){const e=document.getElementById("body_result"),n=e.getBoundingClientRect(),a=e.querySelectorAll('button[data-facs-target-class="pb"]');let o;if(r===l.HORIZONTAL){const t=n.top+n.height/2;for(const e of a){const a=e.getBoundingClientRect();if(0!==a.width||0!==a.height){if(a.top>n.top&&a.top<t){o=e;break}if(!(a.top<=n.top))break;o=e}}}else{const t=n.left+n.width/2;for(const e of a){const a=e.getBoundingClientRect();if(0!==a.width||0!==a.height){if(a.right<n.right&&a.right>t){o=e;break}if(!(a.right>=n.right))break;o=e}}}o&&(o!==ot||t)&&(ot=o,$("#home_tab").hasClass("active")&&it&&$(ot).trigger("click"))}$("#home_tab").on("shown.bs.tab",function(){ct(!0)});document.getElementById("body_result").addEventListener("scroll",function(){ct(!1)})};